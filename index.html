<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#F8FAFC">
    <title>Cash Flow | Ultimate</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { slate: { 850: '#151F2E', 950: '#020617' } } } }
        }
    </script>
    <!-- Chart.js & Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-sankey"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { --bg-body: #F8FAFC; --primary: #4F46E5; }
        .dark { --bg-body: #0F172A; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); transition: background-color 0.3s; color: #1E293B; }
        .dark body { color: #F8FAFC; }

        .neo-card { background: white; border-radius: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.02), 0 10px 25px rgba(0,0,0,0.03); border: 1px solid #F1F5F9; transition: all 0.3s; }
        .dark .neo-card { background: #1E293B; border-color: #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        
        .neo-input { background: #F1F5F9; border: none; border-radius: 12px; padding: 14px; font-weight: 500; width: 100%; color: #0F172A; }
        .dark .neo-input { background: #334155; color: #F8FAFC; }
        .neo-input:focus { box-shadow: 0 0 0 2px var(--primary); outline: none; }

        .view-section { display: none; padding-bottom: 120px; }
        .view-section.active { display: block; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .desktop-nav-item { border-radius: 12px; margin-bottom: 4px; color: #64748B; font-weight: 600; }
        .dark .desktop-nav-item { color: #94A3B8; }
        .desktop-nav-item:hover { background: #F8FAFC; color: #334155; }
        .dark .desktop-nav-item:hover { background: #334155; color: white; }
        .desktop-nav-item.active { background: #EEF2FF; color: var(--primary); }
        .dark .desktop-nav-item.active { background: rgba(79, 70, 229, 0.2); color: #818CF8; }

        .privacy-active .money-val { filter: blur(6px); transition: filter 0.3s; }
        .money-val { transition: filter 0.3s; }

        .budget-bar-bg { background: #F1F5F9; border-radius: 99px; height: 8px; overflow: hidden; }
        .dark .budget-bar-bg { background: #334155; }
        .budget-bar-fill { height: 100%; border-radius: 99px; transition: width 0.5s ease; }

        .nav-dock { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 20px 40px rgba(0,0,0,0.1); border-radius: 24px; margin: 0 16px 16px 16px; }
        .dark .nav-dock { background: rgba(30, 41, 59, 0.9); border-color: rgba(255,255,255,0.1); }
        .nav-item.active { color: var(--primary); transform: scale(1.1); }
        .nav-item { transition: all 0.3s; }

        #toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 100; pointer-events: none; }
        .toast { background: #1E293B; color: white; padding: 12px 24px; border-radius: 12px; margin-top: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); font-weight: 600; font-size: 14px; opacity: 0; transform: translateY(20px); transition: all 0.3s; display: flex; align-items: center; gap: 8px; pointer-events: auto; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background: #064E3B; border: 1px solid #059669; }
        .toast.error { background: #7F1D1D; border: 1px solid #DC2626; }

        #loading-screen { position: fixed; inset: 0; background: rgba(255,255,255,0.98); dark:background: rgba(15,23,42,0.98); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; pointer-events: all; }
        .dark #loading-screen { background: rgba(15,23,42,0.98); }
        .loader-spin { width: 40px; height: 40px; border: 4px solid #E2E8F0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Error Box */
        #error-log { display: none; margin-top: 20px; padding: 15px; background: #FEF2F2; border: 1px solid #FECACA; color: #991B1B; border-radius: 12px; font-size: 12px; font-family: monospace; max-width: 90%; word-break: break-all; }

        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- SAFETY LOADER -->
    <div id="loading-screen" class="hidden">
        <div class="loader-spin mb-4"></div>
        <div class="text-slate-900 dark:text-white font-bold text-lg">Syncing...</div>
        <div class="text-slate-500 text-sm mb-4" id="loading-text">Connecting to secure cloud</div>
        <div id="error-log"></div>
        <button onclick="enableGuestMode()" class="mt-4 text-xs font-bold text-indigo-500 underline hidden" id="guest-btn">Switch to Guest Mode (Offline)</button>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>
    <input type="file" id="csvFileInput" accept=".csv" class="hidden">

    <!-- AUTH OVERLAY -->
    <div id="auth-overlay" class="fixed inset-0 z-50 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl flex flex-col items-center justify-center p-6">
        <div class="bg-white dark:bg-slate-800 p-10 rounded-[32px] max-w-sm w-full text-center shadow-2xl border border-slate-100 dark:border-slate-700">
            <div class="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-xl rotate-3">
                <i class="fas fa-wave-square text-white text-4xl"></i>
            </div>
            <h1 class="text-4xl font-extrabold text-slate-900 dark:text-white mb-2">Cash Flow.</h1>
            <p class="text-slate-500 dark:text-slate-400 mb-10 font-medium">Safe Cloud Sync</p>
            <button id="btn-login" class="w-full bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-bold py-4 rounded-2xl hover:scale-[1.02] transition-transform flex items-center justify-center gap-3 shadow-lg">
                <i class="fab fa-google text-lg"></i> Continue with Google
            </button>
            <p id="auth-status" class="text-xs text-rose-500 mt-6 min-h-[1rem] font-medium"></p>
            <button onclick="enableGuestMode()" class="mt-4 text-xs text-slate-400 hover:text-indigo-500 underline">Continue as Guest (No Sync)</button>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="hidden md:flex flex-col w-72 bg-white dark:bg-slate-900 border-r border-slate-100 dark:border-slate-800 z-20 transition-colors">
        <div class="p-8">
            <div class="flex items-center gap-3 text-2xl font-bold text-slate-900 dark:text-white">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-lg"><i class="fas fa-wave-square"></i></div>
                Cash Flow
            </div>
        </div>
        <nav class="flex-1 px-6 space-y-1">
            <button onclick="router('dashboard')" id="d-nav-dashboard" class="desktop-nav-item w-full flex items-center px-4 py-3.5 text-sm gap-4"><i class="fas fa-home w-5"></i> Home</button>
            <button onclick="router('analysis')" id="d-nav-analysis" class="desktop-nav-item w-full flex items-center px-4 py-3.5 text-sm gap-4"><i class="fas fa-chart-pie w-5"></i> Analysis</button>
            <button onclick="router('debts')" id="d-nav-debts" class="desktop-nav-item w-full flex items-center px-4 py-3.5 text-sm gap-4"><i class="fas fa-file-invoice-dollar w-5"></i> Debts</button>
            <button onclick="router('accounts')" id="d-nav-accounts" class="desktop-nav-item w-full flex items-center px-4 py-3.5 text-sm gap-4"><i class="fas fa-wallet w-5"></i> Accounts</button>
            <button onclick="router('transactions')" id="d-nav-transactions" class="desktop-nav-item w-full flex items-center px-4 py-3.5 text-sm gap-4"><i class="fas fa-list-ul w-5"></i> Activity</button>
            <button onclick="openModal('categoryModal')" class="desktop-nav-item w-full flex items-center px-4 py-3.5 text-sm gap-4 text-indigo-500 font-bold bg-indigo-50 dark:bg-indigo-900/10"><i class="fas fa-tags w-5"></i> Categories</button>
        </nav>
        <div class="p-6 border-t border-slate-50 dark:border-slate-800">
            <div id="connection-status" class="text-[10px] font-bold text-slate-400 mb-2 text-center uppercase tracking-wide">Waiting...</div>
            <div class="flex items-center justify-between mb-4">
                <button onclick="toggleTheme()" class="text-slate-400 hover:text-indigo-500"><i class="fas fa-moon text-lg"></i></button>
                <button onclick="togglePrivacy()" class="text-slate-400 hover:text-indigo-500" title="Privacy Mode"><i class="fas fa-eye text-lg"></i></button>
            </div>
            <div class="flex gap-2 mb-2">
                <button onclick="exportCSV()" class="flex-1 py-2 text-xs font-bold text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-xl transition"><i class="fas fa-download mr-1"></i> Export</button>
                <button onclick="document.getElementById('csvFileInput').click()" class="flex-1 py-2 text-xs font-bold text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-xl transition"><i class="fas fa-upload mr-1"></i> Import</button>
            </div>
            <button id="btn-logout" class="w-full py-2 text-xs font-bold text-rose-600 bg-rose-50 dark:bg-rose-900/20 hover:bg-rose-100 dark:hover:bg-rose-900/30 rounded-xl transition">Sign Out</button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 relative flex flex-col h-full overflow-hidden transition-colors" id="main-container">
        <!-- Mobile Header -->
        <header class="md:hidden flex items-center justify-between p-6 pb-2 z-30 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md sticky top-0">
            <div><h1 class="text-2xl font-extrabold dark:text-white">Hello!</h1><p class="text-slate-500 text-sm font-medium">Financial Overview</p></div>
            <div class="flex gap-2">
                <button onclick="toggleTheme()" class="w-10 h-10 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-slate-500"><i class="fas fa-moon"></i></button>
                <button onclick="togglePrivacy()" class="w-10 h-10 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-slate-500"><i class="fas fa-eye"></i></button>
                <button onclick="openModal('categoryModal')" class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center"><i class="fas fa-tags"></i></button>
            </div>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="view-section flex-1 overflow-y-auto p-6 md:p-10">
            <div class="max-w-6xl mx-auto space-y-8">
                <!-- Net Worth -->
                <div class="relative overflow-hidden rounded-[32px] bg-indigo-600 text-white shadow-xl shadow-indigo-200 dark:shadow-none p-8">
                    <div class="absolute -top-20 -right-20 w-64 h-64 bg-white opacity-10 rounded-full blur-3xl"></div>
                    <div class="absolute bottom-0 left-0 w-48 h-48 bg-purple-500 opacity-20 rounded-full blur-3xl"></div>
                    <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                        <div><div class="text-indigo-100 text-sm font-medium mb-1 uppercase tracking-wider opacity-80">Total Net Worth</div><div class="text-4xl md:text-5xl font-bold tracking-tight money-val" id="dash-networth">...</div></div>
                        <div class="flex gap-3"><button onclick="openNewTx()" class="bg-white text-indigo-600 px-6 py-3 rounded-xl font-bold text-sm hover:bg-indigo-50 transition shadow-lg"><i class="fas fa-plus mr-2"></i> Add Tx</button></div>
                    </div>
                </div>

                <!-- Upcoming Bills Widget -->
                <div class="neo-card p-6" id="upcoming-bills-card" style="display:none">
                    <h3 class="font-bold text-lg mb-4 text-slate-900 dark:text-white flex items-center gap-2"><i class="fas fa-calendar-alt text-indigo-500"></i> Upcoming Bills</h3>
                    <div id="upcoming-list" class="space-y-3"></div>
                </div>
                
                <!-- Budgets -->
                <div class="neo-card p-6">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg dark:text-white">Monthly Budgets</h3><button onclick="openModal('budgetModal')" class="text-xs font-bold text-indigo-600 bg-indigo-50 dark:bg-indigo-900/30 px-3 py-1 rounded-lg hover:bg-indigo-100 transition">+ Set Limit</button></div>
                    <div id="budget-list" class="space-y-4"></div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="neo-card p-6 flex flex-col justify-center"><div class="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mb-3 text-lg"><i class="fas fa-arrow-up"></i></div><div class="text-slate-500 text-xs font-semibold uppercase tracking-wide">Assets</div><div class="text-2xl font-bold mt-1 dark:text-white money-val" id="dash-assets">...</div></div>
                    <div class="neo-card p-6 flex flex-col justify-center"><div class="w-10 h-10 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mb-3 text-lg"><i class="fas fa-arrow-down"></i></div><div class="text-slate-500 text-xs font-semibold uppercase tracking-wide">Liabilities</div><div class="text-2xl font-bold mt-1 dark:text-white money-val" id="dash-debts">...</div></div>
                </div>
                <!-- Main Chart -->
                <div class="neo-card p-6">
                    <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg dark:text-white">Growth Trend</h3><span class="bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-3 py-1 rounded-full text-xs font-bold">1 Year</span></div>
                    <div class="chart-wrapper p-2" style="height: 220px;"><canvas id="mainChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- ANALYSIS VIEW -->
        <div id="view-analysis" class="view-section flex-1 overflow-y-auto p-6 md:p-10">
            <div class="max-w-6xl mx-auto space-y-8">
                <div class="flex justify-between items-center"><div><h2 class="text-3xl font-bold dark:text-white">Analysis</h2><p class="text-slate-500 font-medium">Flows & Allocation</p></div></div>
                <div class="neo-card p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg dark:text-white">Money Flow</h3>
                        <div class="flex bg-slate-100 dark:bg-slate-800 rounded-xl p-1 gap-1">
                            <button onclick="setAnalysisRange('1M')" id="btn-range-1m" class="filter-btn inactive">1M</button>
                            <button onclick="setAnalysisRange('6M')" id="btn-range-6m" class="filter-btn active">6M</button>
                            <button onclick="setAnalysisRange('1Y')" id="btn-range-1y" class="filter-btn inactive">1Y</button>
                        </div>
                    </div>
                    <div class="chart-wrapper" style="height: 350px;"><canvas id="sankeyChart"></canvas></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="neo-card p-6"><h3 class="font-bold text-lg mb-6 dark:text-white">Monthly Trend</h3><div class="chart-wrapper" style="height: 250px;"><canvas id="monthlyBarChart"></canvas></div></div>
                    <div class="neo-card p-6"><h3 class="font-bold text-lg mb-6 dark:text-white">Allocation</h3><div class="flex items-center justify-center"><div style="height: 200px; width: 200px;"><canvas id="assetPieChart"></canvas></div><div id="asset-legend" class="ml-8 space-y-3 text-sm font-medium text-slate-600 dark:text-slate-400"></div></div></div>
                </div>
            </div>
        </div>

        <!-- DEBTS VIEW -->
        <div id="view-debts" class="view-section flex-1 overflow-y-auto p-6 md:p-10">
            <div class="max-w-6xl mx-auto space-y-8">
                <div class="flex justify-between items-center"><div><h2 class="text-3xl font-bold dark:text-white">Debt Intelligence</h2><p class="text-slate-500 font-medium">Liability Tracking</p></div></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="neo-card p-6"><h3 class="font-bold text-lg mb-4 dark:text-white">Total Obligation</h3><p class="text-xs text-slate-500 mb-6">Principal vs Future Interest</p><div class="chart-wrapper" style="height: 250px;"><canvas id="debtSplitChart"></canvas></div></div>
                    <div class="neo-card p-6"><h3 class="font-bold text-lg mb-4 dark:text-white">Debt Composition</h3><p class="text-xs text-slate-500 mb-6">Distribution by Loan</p><div class="chart-wrapper" style="height: 250px;"><canvas id="debtPieChart"></canvas></div></div>
                </div>
                <div id="debt-list-container" class="space-y-4"></div>
            </div>
        </div>

        <!-- ACCOUNTS & TRANSACTIONS -->
        <div id="view-accounts" class="view-section flex-1 overflow-y-auto p-6 md:p-10">
            <div class="max-w-4xl mx-auto"><div class="flex justify-between items-center mb-8 sticky top-0 bg-[#F8FAFC]/95 dark:bg-[#0F172A]/95 backdrop-blur z-10 py-2"><h2 class="text-3xl font-bold dark:text-white">Accounts</h2><div class="flex gap-2"><button onclick="openModal('transferModal')" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-xl font-bold text-sm hover:bg-indigo-200 transition"><i class="fas fa-exchange-alt mr-2"></i> Transfer</button><button onclick="openModal('accountModal')" class="bg-slate-900 dark:bg-white dark:text-slate-900 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-xl hover:scale-110 transition-transform"><i class="fas fa-plus"></i></button></div></div><div id="accounts-container" class="space-y-6"></div></div>
        </div>
        <div id="view-transactions" class="view-section flex-1 overflow-y-auto p-6 md:p-10">
            <div class="max-w-4xl mx-auto h-full flex flex-col">
                <div class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold dark:text-white">Activity</h2>
                    <div class="flex gap-2">
                        <!-- NEW FILTER DROPDOWNS -->
                        <select id="txCatFilter" onchange="renderTransactionsList()" class="neo-input w-32 py-2 px-3 text-xs h-9">
                            <option value="">All Categories</option>
                        </select>
                        <input type="month" id="txDateFilter" onchange="renderTransactionsList()" class="neo-input w-auto py-2 px-3 text-xs h-9">
                        <button onclick="openNewTx()" class="bg-slate-900 dark:bg-white dark:text-slate-900 text-white w-9 h-9 rounded-full flex items-center justify-center shadow-xl hover:scale-110 transition-transform"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="neo-card flex-1 flex flex-col overflow-hidden"><div class="p-4 border-b border-slate-100 dark:border-slate-700"><div class="relative"><i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i><input type="text" id="tx-search" placeholder="Search transactions..." onkeyup="renderTransactionsList()" class="neo-input pl-11"></div></div><div id="full-tx-list" class="overflow-y-auto flex-1 p-2"></div></div>
            </div>
        </div>
    </main>

    <!-- MOBILE DOCK -->
    <nav class="md:hidden fixed bottom-6 left-4 right-4 z-40">
        <div class="nav-dock flex justify-between items-center px-6 py-4 bg-white/90 dark:bg-slate-800/90 border-slate-200 dark:border-slate-700">
            <button onclick="router('dashboard')" id="m-nav-dashboard" class="nav-item flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-home text-xl"></i></button>
            <button onclick="router('analysis')" id="m-nav-analysis" class="nav-item flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-chart-pie text-xl"></i></button>
            <div class="relative -top-8"><button onclick="openNewTx()" class="w-14 h-14 bg-indigo-600 rounded-full flex items-center justify-center text-white text-xl shadow-xl shadow-indigo-300 hover:scale-110 transition-transform border-4 border-white dark:border-slate-900"><i class="fas fa-plus"></i></button></div>
            <button onclick="router('debts')" id="m-nav-debts" class="nav-item flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-receipt text-xl"></i></button>
            <button onclick="router('accounts')" id="m-nav-accounts" class="nav-item flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-wallet text-xl"></i></button>
        </div>
    </nav>

    <!-- BACKUP MODAL -->
    <div id="backupModal" class="fixed inset-0 z-[60] hidden bg-slate-900/40 backdrop-blur-sm flex items-end md:items-center justify-center sm:p-4 transition-all">
        <div class="bg-white dark:bg-slate-800 rounded-t-[32px] md:rounded-[32px] p-8 w-full max-w-md shadow-2xl animate-[slideUp_0.3s_ease-out]">
            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold dark:text-white">Cloud Backups</h3><button onclick="closeModal('backupModal')" class="text-slate-400"><i class="fas fa-times"></i></button></div>
            <div class="bg-emerald-50 dark:bg-emerald-900/10 p-4 rounded-2xl mb-6"><p class="text-sm text-emerald-700 dark:text-emerald-400 font-bold mb-2">Daily Auto-Backup</p><p class="text-xs text-slate-600 dark:text-slate-400">Snapshot saved daily to database.</p></div>
            <h4 class="font-bold text-sm text-slate-500 uppercase tracking-wide mb-3">Available Points</h4>
            <div id="backup-list" class="space-y-3 max-h-60 overflow-y-auto mb-6"></div>
            <button onclick="forceBackup()" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 transition shadow-lg">Backup Now</button>
        </div>
    </div>

    <!-- MODALS -->
    <div id="budgetModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-sm flex items-end md:items-center justify-center sm:p-4 transition-all"><div class="bg-white dark:bg-slate-800 rounded-t-[32px] md:rounded-[32px] p-8 w-full max-w-md shadow-2xl animate-[slideUp_0.3s_ease-out]"><h3 class="text-2xl font-bold mb-6 dark:text-white">Set Budget</h3><form onsubmit="saveBudget(event)" class="space-y-5"><select id="budgCat" class="neo-input appearance-none"></select><input type="number" step="1" id="budgAmount" required class="neo-input" placeholder="Monthly Limit"><div class="flex gap-4 pt-2"><button type="button" onclick="closeModal('budgetModal')" class="flex-1 py-4 text-slate-500 font-bold bg-slate-100 dark:bg-slate-700 rounded-2xl">Cancel</button><button type="submit" class="flex-1 py-4 bg-indigo-600 text-white font-bold rounded-2xl">Set</button></div></form></div></div>
    <div id="categoryModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-sm flex items-end md:items-center justify-center sm:p-4 transition-all"><div class="bg-white dark:bg-slate-800 rounded-t-[32px] md:rounded-[32px] p-8 w-full max-w-md shadow-2xl animate-[slideUp_0.3s_ease-out] flex flex-col max-h-[80vh]"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold dark:text-white">Manage Categories</h3><button onclick="closeModal('categoryModal')" class="text-slate-400 hover:text-indigo-500"><i class="fas fa-times text-xl"></i></button></div><div class="flex gap-2 mb-4"><input type="text" id="newCatName" class="neo-input" placeholder="New Category"><select id="newCatType" class="neo-input w-32"><option value="expense">Exp</option><option value="income">Inc</option></select><button onclick="addCategory()" class="bg-indigo-600 text-white px-4 rounded-xl shadow-lg"><i class="fas fa-plus"></i></button></div><div id="category-list" class="flex-1 overflow-y-auto space-y-2"></div></div></div>
    <div id="transferModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-sm flex items-end md:items-center justify-center sm:p-4 transition-all"><div class="bg-white dark:bg-slate-800 rounded-t-[32px] md:rounded-[32px] p-8 w-full max-w-md shadow-2xl animate-[slideUp_0.3s_ease-out]"><h3 class="text-2xl font-bold mb-6 flex items-center gap-2 dark:text-white"><i class="fas fa-exchange-alt text-indigo-500"></i> Transfer</h3><form onsubmit="processTransfer(event)" class="space-y-5"><div><label class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1 block">From</label><select id="tfFrom" required class="neo-input appearance-none"></select></div><div><label class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1 block">To</label><select id="tfTo" required class="neo-input appearance-none"></select></div><input type="number" step="1" id="tfAmount" required class="neo-input text-lg font-bold text-indigo-600" placeholder="Amount"><input type="text" id="tfDesc" class="neo-input" placeholder="Note (Optional)"><div class="flex gap-4 pt-2"><button type="button" onclick="closeModal('transferModal')" class="flex-1 py-4 text-slate-500 font-bold bg-slate-100 dark:bg-slate-700 rounded-2xl">Cancel</button><button type="submit" class="flex-1 py-4 bg-indigo-600 text-white font-bold rounded-2xl">Transfer</button></div></form></div></div>
    <div id="txModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-sm flex items-end md:items-center justify-center sm:p-4 transition-all"><div class="bg-white dark:bg-slate-800 rounded-t-[32px] md:rounded-[32px] p-8 w-full max-w-md shadow-2xl animate-[slideUp_0.3s_ease-out]"><h3 class="text-2xl font-bold mb-6 dark:text-white" id="txModalTitle">Log Transaction</h3><form onsubmit="saveTransaction(event)" class="space-y-5"><input type="text" id="txDesc" required class="neo-input" placeholder="What is this for?"><div class="grid grid-cols-2 gap-4"><input type="number" step="1" id="txAmount" required class="neo-input" placeholder="Amount"><input type="date" id="txDate" required class="neo-input text-slate-500"></div><div class="grid grid-cols-2 gap-4"><select id="txType" class="neo-input appearance-none" onchange="renderCategorySelect()"><option value="expense">Expense</option><option value="income">Income</option></select><select id="txCat" class="neo-input appearance-none"></select></div><div><label class="text-[10px] text-slate-400 font-bold uppercase tracking-wider ml-2 mb-1 block">Account</label><select id="txAccount" required class="neo-input appearance-none"></select></div><div class="flex items-center gap-2 mb-2"><input type="checkbox" id="txRecurring" class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"><label for="txRecurring" class="text-sm text-slate-600 dark:text-slate-300 font-medium">Recurring (Monthly Bill)</label></div><div class="flex gap-4 pt-2"><button type="button" onclick="closeModal('txModal')" class="flex-1 py-4 text-slate-500 font-bold bg-slate-100 dark:bg-slate-700 rounded-2xl">Cancel</button><button type="submit" class="flex-1 py-4 bg-indigo-600 text-white font-bold rounded-2xl" id="txSaveBtn">Save</button></div></form></div></div>
    <div id="accountModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-sm flex items-end md:items-center justify-center sm:p-4 transition-all"><div class="bg-white dark:bg-slate-800 rounded-t-[32px] md:rounded-[32px] p-8 w-full max-w-md shadow-2xl animate-[slideUp_0.3s_ease-out]"><h3 class="text-2xl font-bold mb-6 dark:text-white">Add Account</h3><form onsubmit="addAccount(event)" class="space-y-5"><input type="text" id="accName" required class="neo-input" placeholder="Account Name"><input type="number" step="1" id="accBalance" required class="neo-input" placeholder="Current Balance"><select id="accType" onchange="toggleDebtFields()" class="neo-input appearance-none"><option value="cash">Cash / Bank</option><option value="investment">Investment</option><option value="property">Property</option><option value="credit">Credit Card (Debt)</option><option value="loan">Loan (Debt)</option></select><div id="debt-fields" class="hidden grid grid-cols-2 gap-4 p-4 bg-rose-50 dark:bg-rose-900/20 rounded-2xl border border-rose-100 dark:border-rose-900/30"><div class="col-span-2"><label class="text-[10px] text-rose-500 font-bold uppercase tracking-wider">Start Date</label><input type="date" id="accStartDate" class="bg-white dark:bg-slate-800 rounded-lg p-2 w-full mt-1 border-none focus:ring-0 text-sm text-slate-600 dark:text-white"></div><div><label class="text-[10px] text-rose-500 font-bold uppercase tracking-wider">Interest %</label><input type="number" step="0.1" id="accRoi" class="bg-white dark:bg-slate-800 rounded-lg p-2 w-full mt-1 border-none focus:ring-0 text-sm" placeholder="8.5"></div><div><label class="text-[10px] text-rose-500 font-bold uppercase tracking-wider">Months</label><input type="number" id="accTenure" class="bg-white dark:bg-slate-800 rounded-lg p-2 w-full mt-1 border-none focus:ring-0 text-sm" placeholder="60"></div><div class="col-span-2 text-xs text-indigo-600 font-bold mt-1" id="emi-preview"></div></div><div class="flex gap-4 pt-2"><button type="button" onclick="closeModal('accountModal')" class="flex-1 py-4 text-slate-500 font-bold bg-slate-100 dark:bg-slate-700 rounded-2xl">Cancel</button><button type="submit" class="flex-1 py-4 bg-indigo-600 text-white font-bold rounded-2xl">Save</button></div></form></div></div>
    <div id="payDebtModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-sm flex items-end md:items-center justify-center sm:p-4 transition-all"><div class="bg-white dark:bg-slate-800 rounded-t-[32px] md:rounded-[32px] p-8 w-full max-w-md shadow-2xl animate-[slideUp_0.3s_ease-out]"><h3 class="text-2xl font-bold mb-6 flex items-center gap-2 dark:text-white"><i class="fas fa-money-bill-wave text-emerald-500"></i> Pay Debt</h3><form onsubmit="processDebtPayment(event)" class="space-y-5"><div><label class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1 block">Paying Loan</label><input type="text" id="pdLoanName" class="neo-input opacity-60" readonly></div><div><label class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1 block">Pay From</label><select id="pdSource" required class="neo-input appearance-none"></select></div><input type="number" step="1" id="pdAmount" required class="neo-input text-lg font-bold text-emerald-600" placeholder="Amount"><div class="flex gap-4 pt-2"><button type="button" onclick="closeModal('payDebtModal')" class="flex-1 py-4 text-slate-500 font-bold bg-slate-100 dark:bg-slate-700 rounded-2xl">Cancel</button><button type="submit" class="flex-1 py-4 bg-emerald-600 text-white font-bold rounded-2xl">Pay</button></div></form></div></div>

    <!-- LOGIC & FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, orderBy, query, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDVCcds_UxopRp6Vw3vL0YYzr9IjIjR6Lc",
            authDomain: "expense-and-income-faf13.firebaseapp.com",
            projectId: "expense-and-income-faf13",
            storageBucket: "expense-and-income-faf13.firebasestorage.app",
            messagingSenderId: "1278622168",
            appId: "1:1278622168:web:b6e94a4d440d17d7b75aad"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // DEFAULTS
        const defaultCategories = {
            income: ['Salary', 'Freelance', 'Business', 'Other Income'],
            expense: ['Food & Dining', 'Housing', 'Transportation', 'Shopping', 'Entertainment', 'Health', 'EMI/Debt', 'Misc']
        };

        let currentUser = null;
        let isDataLoaded = false;
        let state = { accounts: [], transactions: [], history: [0], budgets: {}, categories: JSON.parse(JSON.stringify(defaultCategories)) };
        let chartInst=null, sankeyInst=null, barChartInst=null, assetPieInst=null, debtSplitInst=null, debtPieInst=null, analysisRange='6M';
        let editingTxId = null, payingLoanId = null;

        const els = { overlay: document.getElementById('auth-overlay'), status: document.getElementById('auth-status'), name: document.getElementById('user-name'), avatar: document.getElementById('user-avatar'), nw: document.getElementById('dash-networth'), as: document.getElementById('dash-assets'), db: document.getElementById('dash-debts') };

        document.getElementById('btn-login').onclick = async () => { els.status.innerText = "Connecting..."; try { await signInWithPopup(auth, provider); } catch(e) { els.status.innerText = e.message; } };
        document.getElementById('btn-logout').onclick = () => signOut(auth);
        if(document.getElementById('mob-btn-logout')) document.getElementById('mob-btn-logout').onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if(user) { currentUser = user; els.overlay.classList.add('hidden'); els.name.innerText = user.displayName; els.avatar.src = user.photoURL; els.avatar.classList.remove('hidden'); initSync(); } 
            else { currentUser = null; els.overlay.classList.remove('hidden'); els.status.innerText = ""; isDataLoaded = false; }
        });

        // GUEST MODE
        window.enableGuestMode = () => {
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('loading-screen').classList.add('hidden');
            state = { accounts: [], transactions: [], history: [0], budgets: {}, categories: JSON.parse(JSON.stringify(defaultCategories)) };
            isDataLoaded = true; // Local mode
            currentUser = null;
            render();
            if(document.getElementById('connection-status')) {
                document.getElementById('connection-status').innerText = "Guest (Local Only)";
                document.getElementById('connection-status').className = "text-[10px] font-bold text-amber-500 mb-2 text-center uppercase tracking-wide";
            }
        };

        async function initSync() {
            document.getElementById('loading-screen').classList.remove('hidden');
            const statusEl = document.getElementById('connection-status');
            
            // 1. Get Live Data
            try {
                const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                if(userDoc.exists()) {
                    const data = userDoc.data();
                    state = { ...state, ...data };
                    if(!state.categories) state.categories = JSON.parse(JSON.stringify(defaultCategories)); 
                } else {
                    await setDoc(doc(db, "users", currentUser.uid), state);
                }
                isDataLoaded = true;
                document.getElementById('loading-screen').classList.add('hidden');
                
                // 2. Daily Backup Check
                checkAndRunDailyBackup();
                
                render();
                if(statusEl) {
                    statusEl.innerText = "Sync Active";
                    statusEl.className = "text-[10px] font-bold text-emerald-500 mb-2 text-center uppercase tracking-wide";
                }
            } catch(e) {
                console.error("Sync Error", e);
                document.getElementById('loading-text').innerText = "Connection Failed: " + e.code;
                document.getElementById('loading-text').classList.add('text-rose-500');
                
                if(statusEl) {
                    statusEl.innerText = "Sync Error";
                    statusEl.className = "text-[10px] font-bold text-rose-500 mb-2 text-center uppercase tracking-wide";
                }
                
                // Show Error on screen
                const errLog = document.getElementById('error-log');
                errLog.style.display = 'block';
                errLog.innerText = e.message;
                
                // Show Guest Button
                document.getElementById('guest-btn').classList.remove('hidden');
            }

            if(localStorage.getItem('theme')==='dark') document.documentElement.classList.add('dark');
            if(localStorage.getItem('privacy')==='true') document.getElementById('main-container').classList.add('privacy-active');
        }

        async function save() { 
            if(currentUser && isDataLoaded) { await setDoc(doc(db, "users", currentUser.uid), state); } 
        }

        // --- BACKUP LOGIC ---
        async function checkAndRunDailyBackup() {
            const today = new Date().toISOString().split('T')[0];
            const lastBackup = localStorage.getItem('lastBackupDate');
            if (lastBackup !== today) { await forceBackup(true); }
        }
        window.forceBackup = async (isAuto = false) => {
            if(!currentUser || !isDataLoaded) return;
            const today = new Date().toISOString().split('T')[0];
            const backupRef = collection(db, "users", currentUser.uid, "backups");
            try {
                await addDoc(backupRef, { timestamp: new Date(), dateStr: today, data: state });
                localStorage.setItem('lastBackupDate', today);
                if(!isAuto) { showToast("Backup created successfully"); renderBackups(); }
            } catch(e) { console.error("Backup Failed", e); if(!isAuto) showToast("Backup Failed", "error"); }
        };
        window.restoreBackup = async (id) => { if(!confirm("Restore this backup? Current data will be overwritten.")) return; showToast("Restoring... (Refresh page after 5s)"); };
        window.renderBackups = async () => {
            const list = document.getElementById('backup-list'); list.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            try {
                const q = query(collection(db, "users", currentUser.uid, "backups"), orderBy("timestamp", "desc"), limit(5));
                const snap = await getDocs(q); list.innerHTML = ''; if(snap.empty) { list.innerHTML = '<div class="text-xs text-slate-400 text-center">No backups yet</div>'; return; }
                snap.forEach(doc => { const b = doc.data(); const date = b.timestamp.toDate().toLocaleString(); list.innerHTML += `<div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl"><div><div class="text-sm font-bold dark:text-white">${date}</div><div class="text-[10px] text-slate-400">Auto Backup</div></div><button class="text-xs bg-white dark:bg-slate-600 px-3 py-1 rounded-lg border border-slate-200 dark:border-slate-500 shadow-sm hover:bg-indigo-50">Saved</button></div>`; });
            } catch(e) { list.innerHTML = '<div class="text-xs text-rose-500">Error loading backups</div>'; }
        };

        window.toggleTheme = () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark')?'dark':'light'); };
        window.togglePrivacy = () => { document.getElementById('main-container').classList.toggle('privacy-active'); localStorage.setItem('privacy', document.getElementById('main-container').classList.contains('privacy-active')); };
        
        function showToast(msg, type='success') {
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerHTML = type==='success' ? `<i class="fas fa-check-circle"></i> ${msg}` : `<i class="fas fa-exclamation-circle"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(el);
            setTimeout(() => el.classList.add('show'), 100);
            setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, 3000);
        }

        window.addCategory = () => {
            const name = document.getElementById('newCatName').value.trim(); const type = document.getElementById('newCatType').value;
            if(!name) return;
            if(state.categories[type].includes(name)) { showToast("Category exists", "error"); return; }
            state.categories[type].push(name); save(); document.getElementById('newCatName').value = ''; renderCategoryList(); showToast("Category added");
        };
        window.deleteCategory = (type, name) => { if(confirm(`Delete category '${name}'?`)) { state.categories[type] = state.categories[type].filter(c => c !== name); save(); renderCategoryList(); showToast("Category deleted"); } };
        function renderCategoryList() {
            const list = document.getElementById('category-list'); list.innerHTML = '';
            ['income', 'expense'].forEach(type => {
                const color = type === 'income' ? 'text-emerald-500' : 'text-rose-500';
                state.categories[type].forEach(cat => { list.innerHTML += `<div class="flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700"><span class="${color} font-bold text-sm">${cat}</span><button onclick="deleteCategory('${type}', '${cat}')" class="text-slate-400 hover:text-rose-500"><i class="fas fa-trash"></i></button></div>`; });
            });
        }
        
        window.renderCategorySelect = () => {
            const type = document.getElementById('txType').value;
            const catSelect = document.getElementById('txCat');
            const budgSelect = document.getElementById('budgCat');
            const filterSelect = document.getElementById('txCatFilter');

            if(catSelect) {
                catSelect.innerHTML = '';
                state.categories[type].forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; catSelect.appendChild(opt); });
            }
            if(budgSelect) {
                budgSelect.innerHTML = '';
                state.categories['expense'].forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; budgSelect.appendChild(opt); });
            }
            if(filterSelect && filterSelect.options.length <= 1) { 
                ['income', 'expense'].forEach(t => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = t.toUpperCase();
                    state.categories[t].forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; optgroup.appendChild(opt); });
                    filterSelect.appendChild(optgroup);
                });
            }
        };

        window.saveBudget = (e) => { e.preventDefault(); state.budgets[document.getElementById('budgCat').value] = parseFloat(document.getElementById('budgAmount').value); save(); closeModal('budgetModal'); showToast("Budget updated"); };
        function renderBudgets() {
            const container = document.getElementById('budget-list');
            if(Object.keys(state.budgets).length === 0) { container.innerHTML = '<div class="text-center text-slate-400 text-sm py-4">No budgets set. Click + to add.</div>'; return; }
            container.innerHTML = '';
            const cm = new Date().getMonth(); const cy = new Date().getFullYear();
            const spend = {};
            state.transactions.forEach(t => { const d = new Date(t.date); if(t.type === 'expense' && d.getMonth()===cm && d.getFullYear()===cy) { spend[t.cat] = (spend[t.cat] || 0) + t.amount; } });
            for(const [cat, limit] of Object.entries(state.budgets)) {
                const used = spend[cat] || 0; const pct = Math.min(100, (used/limit)*100); const color = pct > 100 ? 'bg-rose-500' : (pct > 80 ? 'bg-orange-400' : 'bg-emerald-500');
                container.innerHTML += `<div class="mb-3"><div class="flex justify-between text-xs font-bold mb-1 text-slate-700 dark:text-slate-300"><span>${cat}</span><span class="money-val">${money(used)} / ${money(limit)}</span></div><div class="budget-bar-bg w-full"><div class="budget-bar-fill ${color}" style="width: ${pct}%"></div></div></div>`;
            }
        }

        function renderUpcoming() {
            const container = document.getElementById('upcoming-list'); const card = document.getElementById('upcoming-bills-card'); const today = new Date().getDate();
            const upcoming = state.transactions.filter(t => t.recurring).map(t => {
                const d = new Date(t.date).getDate(); let daysLeft = d - today; if(daysLeft < 0) daysLeft += 30; 
                return { ...t, daysLeft };
            }).sort((a,b) => a.daysLeft - b.daysLeft).slice(0, 3);
            if(upcoming.length === 0) { card.style.display = 'none'; return; }
            card.style.display = 'block'; container.innerHTML = '';
            upcoming.forEach(t => {
                const urgency = t.daysLeft <= 3 ? 'text-rose-500' : 'text-slate-500';
                container.innerHTML += `<div class="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-800 rounded-lg"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xs font-bold">${new Date(t.date).getDate()}</div><div class="text-sm font-bold text-slate-700 dark:text-slate-200">${t.desc}</div></div><div class="text-right"><div class="font-bold text-slate-900 dark:text-white money-val">${money(t.amount)}</div><div class="text-[10px] ${urgency} font-bold">In ${t.daysLeft} days</div></div></div>`;
            });
        }

        window.toggleDebtFields = () => { const t=document.getElementById('accType').value; const f=document.getElementById('debt-fields'); if(['loan','credit'].includes(t)) f.classList.remove('hidden'); else f.classList.add('hidden'); };
        function calculateEMI(p, r, n) { if(!p||!r||!n) return 0; const rm = r/12/100; return Math.round(p * rm * (Math.pow(1+rm, n) / (Math.pow(1+rm, n)-1))); }
        ['accBalance','accRoi','accTenure'].forEach(id => { document.getElementById(id).addEventListener('input', () => { const p = parseFloat(document.getElementById('accBalance').value)||0, r = parseFloat(document.getElementById('accRoi').value)||0, n = parseFloat(document.getElementById('accTenure').value)||0; if(p&&r&&n) document.getElementById('emi-preview').innerText = `Estimated EMI: ${money(calculateEMI(p,r,n))}/mo`; }); });

        window.addAccount = (e) => {
            e.preventDefault();
            const type = document.getElementById('accType').value;
            let emi = 0, roi = 0, tenure = 0, startDate = '';
            if(['loan','credit'].includes(type)) {
                const p = parseFloat(document.getElementById('accBalance').value)||0; roi = parseFloat(document.getElementById('accRoi').value)||0; tenure = parseFloat(document.getElementById('accTenure').value)||0;
                emi = calculateEMI(p, roi, tenure);
                startDate = document.getElementById('accStartDate').value;
            }
            state.accounts.push({ id: Date.now(), name: document.getElementById('accName').value, balance: parseFloat(document.getElementById('accBalance').value), type, roi, tenure, emi, startDate });
            save(); closeModal('accountModal'); e.target.reset(); document.getElementById('debt-fields').classList.add('hidden'); showToast("Account added");
        };

        window.openEditTx = (id) => {
            const tx = state.transactions.find(t => t.id === id); if(!tx) return;
            editingTxId = id;
            document.getElementById('txDesc').value = tx.desc; document.getElementById('txAmount').value = tx.amount;
            document.getElementById('txDate').value = tx.date; document.getElementById('txType').value = tx.type;
            renderCategorySelect(); 
            document.getElementById('txCat').value = tx.cat;
            if(tx.recurring) document.getElementById('txRecurring').checked = true;
            const acc = state.accounts.find(a => a.name === tx.accName); if(acc) document.getElementById('txAccount').value = acc.id;
            document.getElementById('txModalTitle').innerText = "Edit Transaction"; document.getElementById('txSaveBtn').innerText = "Update";
            openModal('txModal');
        };

        window.openNewTx = () => {
            editingTxId = null;
            document.getElementById('txModalTitle').innerText = "Log Transaction"; document.getElementById('txSaveBtn').innerText = "Save";
            document.querySelector('#txModal form').reset(); document.getElementById('txDate').valueAsDate = new Date();
            renderCategorySelect(); 
            openModal('txModal');
        };

        window.saveTransaction = (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('txAmount').value);
            const type = document.getElementById('txType').value;
            const accId = parseFloat(document.getElementById('txAccount').value);
            const accIndex = state.accounts.findIndex(a => a.id === accId);
            
            if(accIndex !== -1) {
                const acc = state.accounts[accIndex];
                if (editingTxId) {
                    const oldTx = state.transactions.find(t => t.id === editingTxId);
                    if(oldTx) {
                        const oldAcc = state.accounts.find(a => a.name === oldTx.accName);
                        if(oldAcc) {
                            if(oldTx.type==='income'){ if(['credit','loan'].includes(oldAcc.type)) oldAcc.balance+=oldTx.amount; else oldAcc.balance-=oldTx.amount; }
                            else { if(['credit','loan'].includes(oldAcc.type)) oldAcc.balance-=oldTx.amount; else oldAcc.balance+=oldTx.amount; }
                        }
                    }
                }
                if(type==='income'){ if(['credit','loan'].includes(acc.type)) acc.balance-=amount; else acc.balance+=amount; }
                else { if(['credit','loan'].includes(acc.type)) acc.balance+=amount; else acc.balance-=amount; }
                
                const txData = { desc: document.getElementById('txDesc').value, amount, date: document.getElementById('txDate').value, type, cat: document.getElementById('txCat').value, accName: acc.name, recurring: document.getElementById('txRecurring').checked };
                if(editingTxId) { const idx = state.transactions.findIndex(t=>t.id===editingTxId); state.transactions[idx] = { ...state.transactions[idx], ...txData }; }
                else { state.transactions.unshift({ id: Date.now(), ...txData }); }
                save(); closeModal('txModal'); showToast("Transaction saved");
            }
        };

        window.processTransfer = (e) => {
            e.preventDefault();
            const fromId=parseFloat(document.getElementById('tfFrom').value), toId=parseFloat(document.getElementById('tfTo').value), amt=parseFloat(document.getElementById('tfAmount').value);
            if(fromId===toId) { showToast("Same account!", "error"); return; }
            const fromAcc=state.accounts.find(a=>a.id===fromId), toAcc=state.accounts.find(a=>a.id===toId);
            if(fromAcc&&toAcc){
                if(['credit','loan'].includes(fromAcc.type)) fromAcc.balance+=amt; else fromAcc.balance-=amt;
                if(['credit','loan'].includes(toAcc.type)) toAcc.balance-=amt; else toAcc.balance+=amt;
                state.transactions.unshift({ id:Date.now(), desc:`Transfer: ${fromAcc.name}  ${toAcc.name}`, amount:amt, date:new Date().toISOString().split('T')[0], type:'expense', cat:'Transfer', accName:fromAcc.name });
                save(); closeModal('transferModal'); showToast("Transfer complete");
            }
        };

        // NEW: PAY DEBT LOGIC
        window.openPayDebt = (loanId) => {
            payingLoanId = loanId;
            const loan = state.accounts.find(a => a.id === loanId);
            if(loan) {
                document.getElementById('pdLoanName').value = loan.name;
                document.getElementById('pdAmount').value = loan.emi || 0;
                
                // Populate Source (Only Assets)
                const select = document.getElementById('pdSource'); select.innerHTML = '';
                const assets = state.accounts.filter(a => ['cash', 'investment'].includes(a.type));
                assets.forEach(a => { const o = document.createElement('option'); o.value = a.id; o.innerText = `${a.name} (${money(a.balance)})`; select.appendChild(o); });
                
                openModal('payDebtModal');
            }
        };

        window.processDebtPayment = (e) => {
            e.preventDefault();
            const sourceId = parseFloat(document.getElementById('pdSource').value);
            const amount = parseFloat(document.getElementById('pdAmount').value);
            
            const sourceAcc = state.accounts.find(a => a.id === sourceId);
            const loanAcc = state.accounts.find(a => a.id === payingLoanId);

            if(sourceAcc && loanAcc) {
                sourceAcc.balance -= amount; // Deduct from bank
                loanAcc.balance -= amount; // Reduce loan
                
                state.transactions.unshift({
                    id: Date.now(),
                    desc: `EMI: ${loanAcc.name}`,
                    amount: amount,
                    date: new Date().toISOString().split('T')[0],
                    type: 'expense',
                    cat: 'EMI/Debt',
                    accName: sourceAcc.name
                });
                save(); closeModal('payDebtModal'); showToast("EMI Paid Successfully");
            }
        };

        window.deleteItem = (list, id) => { if(confirm('Delete?')) { state[list] = state[list].filter(i=>i.id!==id); save(); showToast("Deleted"); } };
        const money = (n) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(n);
        const formatDateIN = (d) => { if(!d) return ''; const [y,m,dd] = d.split('-'); return `${dd}/${m}/${y}`; };
        window.setAnalysisRange = (range) => { analysisRange = range; render(); };

        window.exportCSV = () => {
            let csv = "\uFEFFID,Date,Description,Amount,Type,Category,Account\n";
            state.transactions.forEach(t => csv += `${t.id},${t.date},"${t.desc}",${t.amount},${t.type},${t.cat},"${t.accName}"\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'cashflow.csv'; a.click();
        };

        document.getElementById('csvFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const text = event.target.result; const lines = text.split('\n').slice(1); let addedCount = 0;
                lines.forEach(line => {
                    if(!line.trim()) return; const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                    if(cols && cols.length >= 7) {
                        const id = parseFloat(cols[0]); if(state.transactions.some(t => t.id === id)) return; 
                        const accName = cols[6].replace(/"/g, ''); const amount = parseFloat(cols[3]); const type = cols[4];
                        let acc = state.accounts.find(a => a.name === accName);
                        if (!acc) { acc = { id: Date.now() + Math.random(), name: accName, balance: 0, type: 'cash' }; state.accounts.push(acc); }
                        if (type === 'income') { if(['credit', 'loan'].includes(acc.type)) acc.balance -= amount; else acc.balance += amount; }
                        else { if(['credit', 'loan'].includes(acc.type)) acc.balance += amount; else acc.balance -= amount; }
                        state.transactions.unshift({ id: id, date: cols[1], desc: cols[2].replace(/"/g, ''), amount: amount, type: type, cat: cols[5], accName: accName });
                        addedCount++;
                    }
                });
                if(addedCount > 0) { save(); showToast(`Imported ${addedCount} txns`); } else { showToast("No new data", "error"); }
                e.target.value = ''; 
            };
            reader.readAsText(file);
        });

        function updateAccountSelect() {
            const select = document.getElementById('txAccount'); const tfFrom = document.getElementById('tfFrom'); const tfTo = document.getElementById('tfTo');
            [select, tfFrom, tfTo].forEach(s => s.innerHTML = '');
            const assets = state.accounts.filter(a => ['cash', 'investment', 'property'].includes(a.type));
            const debts = state.accounts.filter(a => ['credit', 'loan'].includes(a.type));
            const createOpt = (a) => { const o = document.createElement('option'); o.value = a.id; o.innerText = a.name; return o; };
            if(assets.length) { const g = document.createElement('optgroup'); g.label="Assets"; assets.forEach(a=>{ select.appendChild(createOpt(a)); tfFrom.appendChild(createOpt(a)); tfTo.appendChild(createOpt(a)); }); }
            if(debts.length) { const g = document.createElement('optgroup'); g.label="Credit"; debts.forEach(a=>{ select.appendChild(createOpt(a)); tfFrom.appendChild(createOpt(a)); tfTo.appendChild(createOpt(a)); }); }
        }

        function render() {
            updateAccountSelect();
            renderBudgets();
            renderUpcoming();
            renderCategoryList();
            renderCategorySelect(); 
            
            ['1M','6M','1Y'].forEach(r => { const btn=document.getElementById(`btn-range-${r.toLowerCase()}`); if(r===analysisRange) btn.className="filter-btn active"; else btn.className="filter-btn inactive"; });
            
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#F1F5F9' : '#1E293B';
            const gridColor = isDark ? '#334155' : '#E2E8F0';

            let assets=0, debts=0, totalScheduledEMI=0;
            let assetMap = { 'Cash': 0, 'Investments': 0, 'Property': 0 };
            let totalDebtPrincipal = 0, totalEstimatedInterest = 0;
            let debtCompositionLabels = [], debtCompositionData = [], debtListHTML = "";

            state.accounts.forEach(a => { 
                if(['cash','investment','property'].includes(a.type)) { assets+=a.balance; if(a.type==='cash') assetMap['Cash']+=a.balance; if(a.type==='investment') assetMap['Investments']+=a.balance; if(a.type==='property') assetMap['Property']+=a.balance; } 
                else { 
                    debts+=a.balance; totalDebtPrincipal += a.balance;
                    if(a.emi) {
                        totalScheduledEMI+=a.emi;
                        let monthsElapsed = 0;
                        if(a.startDate) { const start = new Date(a.startDate); const now = new Date(); monthsElapsed = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth()); }
                        const remainingTenure = Math.max(0, (a.tenure || 0) - monthsElapsed);
                        const totalRemainingPayable = a.emi * remainingTenure;
                        const interestComponent = Math.max(0, totalRemainingPayable - a.balance);
                        totalEstimatedInterest += interestComponent;
                        const payoffDate = new Date(); payoffDate.setMonth(payoffDate.getMonth() + remainingTenure);
                        const principalPercent = totalRemainingPayable > 0 ? (a.balance / totalRemainingPayable) * 100 : 0;
                        const interestPercent = 100 - principalPercent;
                        debtListHTML += `<div class="neo-card p-5 border-l-4 border-rose-500 mb-3"><div class="flex justify-between items-start mb-2"><div><h4 class="font-bold text-slate-900 text-lg dark:text-white">${a.name}</h4><span class="text-xs font-semibold bg-rose-100 text-rose-600 px-2 py-0.5 rounded">EMI: ${money(a.emi)}</span></div><div class="text-right"><div class="text-xs text-slate-400 uppercase font-bold">Liability</div><div class="font-bold text-slate-900 dark:text-white text-xl money-val">${money(totalRemainingPayable)}</div></div></div><div class="w-full bg-slate-100 dark:bg-slate-700 h-2 rounded-full mt-2 mb-1 overflow-hidden flex"><div class="bg-primary h-full" style="width: ${principalPercent}%"></div><div class="bg-rose-400 h-full" style="width: ${interestPercent}%"></div></div><div class="flex justify-between text-[10px] text-slate-500 dark:text-slate-400 mb-3"><span class="flex items-center gap-1"><div class="w-2 h-2 bg-primary rounded-full"></div> Principal: ${money(a.balance)}</span><span class="flex items-center gap-1"><div class="w-2 h-2 bg-rose-400 rounded-full"></div> Interest: ${money(totalRemainingPayable - a.balance)}</span></div><div class="grid grid-cols-2 gap-4 pt-2 border-t border-slate-50 dark:border-slate-700 text-xs"><div><span class="text-slate-400 block">Rate</span><span class="font-bold text-slate-700 dark:text-slate-300">${a.roi}%</span></div><div class="text-right"><span class="text-slate-400 block">Payoff Est.</span><span class="font-bold text-slate-700 dark:text-slate-300">${payoffDate.toLocaleDateString('en-IN', {month:'short', year:'numeric'})}</span></div></div></div>`;
                    } else {
                        debtListHTML += `<div class="neo-card p-5 border-l-4 border-orange-400 mb-3"><div class="flex justify-between items-center"><h4 class="font-bold text-slate-900 dark:text-white">${a.name}</h4><div class="font-bold text-slate-900 dark:text-white text-lg money-val">${money(a.balance)}</div></div><div class="text-xs text-slate-400 mt-1">Revolving Credit / Untracked Loan</div></div>`;
                    }
                    debtCompositionLabels.push(a.name);
                    debtCompositionData.push(a.balance);
                } 
            });
            const nw = assets - debts;
            els.nw.innerText = money(nw); els.as.innerText = money(assets); els.db.innerText = money(debts);

            if(state.history[state.history.length-1]!==nw) { state.history.push(nw); if(state.history.length>12) state.history.shift(); }
            const ctx = document.getElementById('mainChart').getContext('2d'); if(chartInst) chartInst.destroy(); chartInst = new Chart(ctx, { type: 'line', data: { labels: Array(state.history.length).fill(''), datasets: [{ data: state.history, borderColor: '#4F46E5', backgroundColor: (c)=>{const gradient=c.chart.ctx.createLinearGradient(0,0,0,200);gradient.addColorStop(0,'rgba(79,70,229,0.2)');gradient.addColorStop(1,'rgba(79,70,229,0)');return gradient;}, borderWidth: 3, fill: true, tension: 0.4, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } } });

            const pieCtx = document.getElementById('assetPieChart').getContext('2d'); if(assetPieInst) assetPieInst.destroy(); assetPieInst = new Chart(pieCtx, { type: 'doughnut', data: { labels: ['Cash', 'Inv', 'Prop'], datasets: [{ data: [assetMap['Cash'], assetMap['Investments'], assetMap['Property']], backgroundColor: ['#10B981', '#3B82F6', '#6366F1'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } } });
            const totalAssets=assets||1; document.getElementById('asset-legend').innerHTML=`<div class="flex justify-between items-center w-full"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500"></span><span>Cash</span></div><span class="font-bold">${((assetMap['Cash']/totalAssets)*100).toFixed(0)}%</span></div><div class="flex justify-between items-center w-full"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span><span>Inv</span></div><span class="font-bold">${((assetMap['Investments']/totalAssets)*100).toFixed(0)}%</span></div><div class="flex justify-between items-center w-full"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-indigo-500"></span><span>Prop</span></div><span class="font-bold">${((assetMap['Property']/totalAssets)*100).toFixed(0)}%</span></div>`;

            if(document.getElementById('view-debts').classList.contains('active')) {
                const debtSplitCtx = document.getElementById('debtSplitChart').getContext('2d'); if(debtSplitInst) debtSplitInst.destroy(); debtSplitInst = new Chart(debtSplitCtx, { type: 'bar', data: { labels: ['Liability'], datasets: [{ label: 'Principal', data: [totalDebtPrincipal], backgroundColor: '#4F46E5', borderRadius: 6 }, { label: 'Interest', data: [totalEstimatedInterest], backgroundColor: '#F43F5E', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, grid: {display:false} }, y: { stacked: true, display: false } } } });
                const debtPieCtx = document.getElementById('debtPieChart').getContext('2d'); if(debtPieInst) debtPieInst.destroy(); debtPieInst = new Chart(debtPieCtx, { type: 'doughnut', data: { labels: debtCompositionLabels, datasets: [{ data: debtCompositionData, backgroundColor: ['#F43F5E', '#F97316', '#EAB308', '#84CC16', '#06B6D4'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } } } });
                document.getElementById('debt-list-container').innerHTML = debtListHTML || '<div class="text-center text-slate-400 py-10">No active debts found.</div>';
            }

            const buckets=[]; const monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; const cm=new Date().getMonth(); const cy=new Date().getFullYear(); const rangeMonths = analysisRange === '1Y' ? 11 : 5;
            for(let i=rangeMonths;i>=0;i--){ const d=new Date(cy,cm-i,1); buckets.push({label:`${monthNames[d.getMonth()]}`, month:d.getMonth(), year:d.getFullYear(), income:0, expense:0}); }
            
            state.accounts.forEach(a => { if(a.emi && a.emi > 0) { buckets.forEach(b => { const bucketDate = new Date(b.year, b.month, 1); const loanStart = a.startDate ? new Date(a.startDate) : new Date(0); loanStart.setDate(1); if (bucketDate >= loanStart) { b.expense += a.emi; } }); } });

            const flows={}; const WALLET="Wallet"; let si=0, so=0;
            state.transactions.forEach(tx=>{
                const txDate=new Date(tx.date); const bi=buckets.findIndex(b=>b.month===txDate.getMonth()&&b.year===txDate.getFullYear());
                if(bi!==-1){ if(tx.type==='income') buckets[bi].income+=tx.amount; else buckets[bi].expense+=tx.amount; }
                let inc=false; if(analysisRange==='1M'){ if(txDate.getMonth()===cm && txDate.getFullYear()===cy) inc=true; } else if(analysisRange==='6M'){ if(bi !== -1 && bi >= buckets.length - 6) inc=true; } else { if(bi !== -1) inc=true; }
                if(inc){ const cat=tx.cat||(tx.type==='income'?'Uncat Inc':'Misc'); const amt=tx.amount; if(tx.type==='income'){ const k=`${cat}|${WALLET}`; flows[k]=(flows[k]||0)+amt; si+=amt; } else { const k=`${WALLET}|${cat}`; flows[k]=(flows[k]||0)+amt; so+=amt; } }
            });
            const emiMul = analysisRange==='1M'?1:(analysisRange==='6M'?6:12); const emiFlow = totalScheduledEMI * emiMul; if(emiFlow>0) { const k=`${WALLET}|EMI`; flows[k]=(flows[k]||0)+emiFlow; so+=emiFlow; }
            const surplus=si-so; if(surplus>0) flows[`${WALLET}|Savings`]=surplus;
            const sankeyData=Object.keys(flows).map(k=>{const[f,t]=k.split('|');return{from:f,to:t,flow:flows[k]};});
            const sankeyCtx=document.getElementById('sankeyChart').getContext('2d');
            if(sankeyInst) sankeyInst.destroy();
            if(sankeyData.length > 0) {
                const getColor = (name) => { if(!name) return '#ccc'; if(name===WALLET) return '#2563EB'; if(name==='Surplus') return '#6366F1'; if(name==='EMI') return '#F43F5E'; if(sankeyData.some(d=>d.from===name&&d.to===WALLET)) return '#10B981'; return '#F43F5E'; };
                sankeyInst = new Chart(sankeyCtx, { type: 'sankey', data: { datasets: [{ data: sankeyData, colorFrom: (c)=>c.dataset.data[c.dataIndex]?getColor(c.dataset.data[c.dataIndex].from):'#ccc', colorTo: (c)=>c.dataset.data[c.dataIndex]?getColor(c.dataset.data[c.dataIndex].to):'#ccc', colorMode: 'gradient', labels: { color: textColor, font: { weight: 'bold', size: 11 }, padding: 10 }, nodeWidth: 20, nodePadding: 20 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: (c) => `${c.raw.from}  ${c.raw.to}: ${money(c.raw.flow)}` } } } } });
            } else { sankeyInst = new Chart(sankeyCtx, { type: 'sankey', data: { datasets: [] } }); }

            const barCtx = document.getElementById('monthlyBarChart').getContext('2d'); if(barChartInst) barChartInst.destroy();
            barChartInst = new Chart(barCtx, { type: 'bar', data: { labels: buckets.map(b => b.label), datasets: [{ label: 'Inc', data: buckets.map(b => b.income), backgroundColor: '#10B981', borderRadius: 4 }, { label: 'Exp', data: buckets.map(b => b.expense), backgroundColor: '#F43F5E', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: gridColor } }, y: { display: false } } } });

            const ac=document.getElementById('accounts-container'); ac.innerHTML='';
            const groups={ 'Liquidity': 'cash', 'Investments': 'investment', 'Real Estate': 'property', 'Debt / Loans': ['credit','loan'] };
            for(const[name,types] of Object.entries(groups)){
                const items=state.accounts.filter(a=>Array.isArray(types)?types.includes(a.type):a.type===types);
                if(items.length){
                    let h=`<div class="neo-card p-5 mb-4"><h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-50 dark:border-slate-700 pb-2">${name}</h4><div class="space-y-4">`;
                    items.forEach(i=>{
                        let sub=i.emi?`<div class="text-[10px] text-rose-500 font-bold bg-rose-50 dark:bg-rose-900/30 px-2 py-0.5 rounded-full inline-block mt-1">EMI: ${money(i.emi)}</div>`:'';
                        if(i.startDate) sub += ` <span class="text-[10px] text-slate-400 ml-1">Since: ${formatDateIN(i.startDate)}</span>`;
                        h+=`<div class="flex justify-between items-center group"><div><div class="font-bold text-slate-800 dark:text-white">${i.name}</div>${sub}</div><div class="flex items-center gap-3"><span class="font-bold text-slate-900 dark:text-white money-val">${money(i.balance)}</span><button onclick="deleteItem('accounts', ${i.id})" class="text-slate-300 hover:text-rose-500 transition"><i class="fas fa-trash"></i></button></div></div>`;
                    });
                    ac.innerHTML+=h+`</div></div>`;
                }
            }

            renderTransactionsList();
        }

        // --- NEW: SEPARATE TX RENDERER FOR PERFORMANCE ---
        window.renderTransactionsList = () => {
            const tc=document.getElementById('full-tx-list'); tc.innerHTML='';
            const term=document.getElementById('tx-search').value.toLowerCase();
            const dateFilter = document.getElementById('txDateFilter').value;
            const catFilter = document.getElementById('txCatFilter').value;
            
            let fTx = state.transactions;
            if(term) fTx = fTx.filter(t => t.desc.toLowerCase().includes(term));
            if(dateFilter) { const [y, m] = dateFilter.split('-'); fTx = fTx.filter(t => { const d = new Date(t.date); return d.getFullYear() === parseInt(y) && (d.getMonth() + 1) === parseInt(m); }); }
            if(catFilter) fTx = fTx.filter(t => t.cat === catFilter);

            if(fTx.length === 0) tc.innerHTML = '<div class="text-center text-slate-400 py-10"><i class="fas fa-wind text-2xl mb-2"></i><p>No activity found</p></div>';
            else fTx.slice(0, 50).forEach(t=>{ // Limit rendering to 50 for speed
                const isInc=t.type==='income';
                let rec = t.recurring ? '<span class="text-[10px] bg-indigo-100 text-indigo-700 px-1 rounded ml-1"></span>' : '';
                tc.innerHTML+=`<div class="flex justify-between items-center p-3 mb-2 bg-white dark:bg-slate-800 rounded-xl border border-slate-50 dark:border-slate-700 hover:shadow-md transition"><div class="flex gap-4 items-center"><div class="w-10 h-10 rounded-full flex items-center justify-center ${isInc?'bg-emerald-50 text-emerald-600 dark:bg-emerald-900/30':'bg-rose-50 text-rose-600 dark:bg-rose-900/30'}"><i class="fas ${isInc?'fa-arrow-down':'fa-arrow-up'}"></i></div><div><div class="font-bold text-slate-800 dark:text-white text-sm">${t.desc} ${rec}</div><div class="text-[10px] text-slate-400 font-medium">${formatDateIN(t.date)}  ${t.accName}</div></div></div><div class="flex gap-3 items-center"><span class="font-bold text-sm ${isInc?'text-emerald-600':'text-slate-900 dark:text-white'} money-val">${isInc?'+':'-'}${money(t.amount)}</span><button onclick="openEditTx(${t.id})" class="text-slate-300 hover:text-blue-500"><i class="fas fa-pencil-alt"></i></button><button onclick="deleteItem('transactions', ${t.id})" class="text-slate-300 hover:text-rose-500"><i class="fas fa-trash"></i></button></div></div>`;
            });
        }

        window.router=(v)=>{document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));document.getElementById('view-'+v).classList.add('active');document.querySelectorAll('.nav-item, .desktop-nav-item').forEach(e=>e.classList.remove('active'));if(document.getElementById('d-nav-'+v))document.getElementById('d-nav-'+v).classList.add('active');if(document.getElementById('m-nav-'+v))document.getElementById('m-nav-'+v).classList.add('active');render();};
        window.openModal=(id)=>{document.getElementById(id).classList.remove('hidden');if(id==='txModal'&&!editingTxId)document.querySelector('#txModalTitle').innerText="Log Transaction"; renderCategoryList();};
        window.closeModal=(id)=>document.getElementById(id).classList.add('hidden');
        document.getElementById('txDate').valueAsDate=new Date(); router('dashboard');
    </script>
</body>
</html>
