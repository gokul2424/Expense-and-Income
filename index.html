<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#F3F4F6">
    <title>Cash Flow | Financial Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js Base -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Sankey Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-sankey"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { 
            --bg-body: #F3F4F6;       /* Gray 100 */
            --bg-card: #FFFFFF;       /* White */
            --text-main: #111827;     /* Gray 900 */
            --text-muted: #6B7280;    /* Gray 500 */
            --accent: #2563EB;        /* Blue 600 */
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* Glass UI - Light Mode */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.9); 
            border: 1px solid rgba(229, 231, 235, 0.8); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        
        /* Transitions */
        .view-section { display: none; padding-bottom: 90px; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Nav Active States */
        .nav-item.active { color: #2563EB; }
        .desktop-nav-item.active { background: #EFF6FF; color: #2563EB; border-right: 3px solid #2563EB; font-weight: 600; }

        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; } 
        ::-webkit-scrollbar-track { background: #F3F4F6; } 
        ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }
    </style>
</head>
<body class="flex h-screen overflow-hidden selection:bg-blue-100 selection:text-blue-900">

    <!-- AUTH OVERLAY -->
    <div id="auth-overlay" class="fixed inset-0 z-50 bg-gray-50 flex flex-col items-center justify-center p-6">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full text-center shadow-xl border border-gray-100">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-200">
                <i class="fas fa-wave-square text-white text-3xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Cash Flow.</h1>
            <p class="text-gray-500 mb-8 text-sm">Personal Finance OS</p>
            <button id="btn-login" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3.5 rounded-xl hover:bg-gray-50 transition flex items-center justify-center gap-3 shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                Continue with Google
            </button>
            <p id="auth-status" class="text-xs text-rose-500 mt-4 min-h-[1rem]"></p>
        </div>
    </div>

    <!-- SIDEBAR (Desktop) -->
    <aside class="hidden md:flex flex-col w-64 bg-white border-r border-gray-200 z-20 shadow-sm">
        <div class="p-6 text-xl font-bold tracking-tight text-gray-900 flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-md shadow-blue-200"><i class="fas fa-wave-square"></i></div> Cash Flow
        </div>
        <nav class="flex-1 px-4 space-y-2 mt-4">
            <button onclick="router('dashboard')" id="d-nav-dashboard" class="desktop-nav-item w-full flex items-center px-4 py-3 text-sm font-medium text-gray-500 rounded-r-lg text-left gap-3 hover:bg-gray-50 transition-all"><i class="fas fa-chart-pie w-5"></i> Dashboard</button>
            <button onclick="router('analysis')" id="d-nav-analysis" class="desktop-nav-item w-full flex items-center px-4 py-3 text-sm font-medium text-gray-500 rounded-r-lg text-left gap-3 hover:bg-gray-50 transition-all"><i class="fas fa-project-diagram w-5"></i> Analysis</button>
            <button onclick="router('accounts')" id="d-nav-accounts" class="desktop-nav-item w-full flex items-center px-4 py-3 text-sm font-medium text-gray-500 rounded-r-lg text-left gap-3 hover:bg-gray-50 transition-all"><i class="fas fa-wallet w-5"></i> Accounts</button>
            <button onclick="router('transactions')" id="d-nav-transactions" class="desktop-nav-item w-full flex items-center px-4 py-3 text-sm font-medium text-gray-500 rounded-r-lg text-left gap-3 hover:bg-gray-50 transition-all"><i class="fas fa-list w-5"></i> Transactions</button>
        </nav>
        <div class="p-4 border-t border-gray-100 bg-gray-50/50">
            <div class="flex items-center gap-3 mb-3">
                <img id="user-avatar" src="" class="w-9 h-9 rounded-full bg-gray-200 hidden border border-white shadow-sm">
                <div class="overflow-hidden">
                    <div id="user-name" class="text-sm font-semibold text-gray-900 truncate">User</div>
                    <div class="text-[10px] text-emerald-600 flex items-center gap-1 font-medium"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span> Sync Active</div>
                </div>
            </div>
            <button id="btn-logout" class="w-full py-2 text-xs font-medium text-rose-600 bg-rose-50 hover:bg-rose-100 rounded border border-rose-100 transition">Sign Out</button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 relative flex flex-col h-full overflow-hidden bg-[#F9FAFB]">
        <!-- Mobile Header -->
        <header class="md:hidden flex items-center justify-between p-4 bg-white/80 backdrop-blur-md border-b border-gray-200 z-30 sticky top-0 shadow-sm">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 bg-blue-600 rounded flex items-center justify-center text-white text-xs shadow-sm"><i class="fas fa-wave-square"></i></div>
                <span class="font-bold text-lg text-gray-900">Cash Flow.</span>
            </div>
            <div id="mob-sync-status" class="w-2 h-2 rounded-full bg-emerald-500"></div>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="view-section flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-6xl mx-auto space-y-6">
                <!-- NET WORTH HEADER -->
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 tracking-tight">Overview</h2>
                        <p class="text-gray-500 text-sm mt-1">Real-time financial health</p>
                    </div>
                    <div class="glass-panel px-5 py-3 rounded-xl border-l-4 border-blue-600 bg-white">
                        <div class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Net Worth</div>
                        <div class="text-3xl font-bold text-gray-900" id="dash-networth">...</div>
                    </div>
                </div>

                <!-- MAIN HISTORY CHART (Line) -->
                <div class="glass-panel rounded-2xl p-1 bg-white">
                    <div class="p-5 pb-0 flex justify-between items-center"><h3 class="font-semibold text-gray-800">Net Worth Trend</h3></div>
                    <div class="chart-wrapper p-4" style="height: 200px;"><canvas id="mainChart"></canvas></div>
                </div>

                <!-- ASSETS / DEBTS GRID -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-panel p-5 rounded-2xl bg-white">
                        <div class="text-xs text-gray-500 font-semibold uppercase">Total Assets</div>
                        <div class="text-xl md:text-2xl font-bold text-gray-900 mt-1" id="dash-assets">...</div>
                    </div>
                    <div class="glass-panel p-5 rounded-2xl bg-white">
                        <div class="text-xs text-gray-500 font-semibold uppercase">Total Debts</div>
                        <div class="text-xl md:text-2xl font-bold text-gray-900 mt-1" id="dash-debts">...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANALYSIS VIEW -->
        <div id="view-analysis" class="view-section flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-6xl mx-auto space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">Analysis</h2>
                        <p class="text-gray-500 text-sm mt-1">Flows, Trends & Asset Allocation</p>
                    </div>
                </div>

                <!-- SANKEY CHART SECTION -->
                <div class="glass-panel rounded-2xl p-6 bg-white">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-gray-900 text-lg">Money Flow</h3>
                        
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button onclick="setAnalysisRange('1M')" id="btn-range-1m" class="px-3 py-1 text-xs font-medium rounded-md text-gray-500 hover:text-blue-600 transition-colors">1 Month</button>
                            <button onclick="setAnalysisRange('6M')" id="btn-range-6m" class="px-3 py-1 text-xs font-medium rounded-md bg-white text-blue-600 shadow-sm transition-all">6 Months</button>
                        </div>
                    </div>
                    
                    <div class="chart-wrapper" style="height: 350px; background: #FAFAFA; border-radius: 12px; padding: 10px; border: 1px solid #F3F4F6;">
                        <canvas id="sankeyChart"></canvas>
                    </div>
                    <div class="mt-4 text-center text-xs text-gray-500 font-medium">
                        <span class="text-emerald-600">● Income</span> &rarr; <span class="text-blue-600">● Wallet</span> &rarr; <span class="text-rose-500">● Expenses</span> & <span class="text-indigo-600">● Surplus</span>
                        <div class="mt-1 text-gray-400 font-normal">Includes Auto-Scheduled EMIs</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- MONTHLY BREAKDOWN (BAR) -->
                    <div class="glass-panel rounded-2xl p-6 bg-white">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold text-gray-900 text-lg">Monthly Trend</h3>
                            <p class="text-xs text-gray-500">Includes EMI</p>
                        </div>
                        <div class="chart-wrapper" style="height: 250px;">
                            <canvas id="monthlyBarChart"></canvas>
                        </div>
                    </div>

                    <!-- ASSET ALLOCATION (PIE) -->
                    <div class="glass-panel rounded-2xl p-6 bg-white">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold text-gray-900 text-lg">Asset Allocation</h3>
                            <p class="text-xs text-gray-500">Portfolio Weightage</p>
                        </div>
                        <div class="flex items-center justify-center">
                            <div class="chart-wrapper" style="height: 200px; width: 200px;">
                                <canvas id="assetPieChart"></canvas>
                            </div>
                            <div id="asset-legend" class="ml-6 space-y-2 text-sm">
                                <!-- Legend Injected by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ACCOUNTS VIEW -->
        <div id="view-accounts" class="view-section flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-3xl mx-auto">
                <div class="flex justify-between items-center mb-6 sticky top-0 md:static z-10 py-2 bg-[#F9FAFB]/90 backdrop-blur-sm">
                    <h2 class="text-2xl font-bold text-gray-900">Accounts</h2>
                    <button onclick="openModal('accountModal')" class="bg-blue-600 hover:bg-blue-700 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg shadow-blue-600/30 transition-all hover:scale-105 active:scale-95"><i class="fas fa-plus"></i></button>
                </div>
                <div id="accounts-container" class="space-y-6 pb-20"></div>
            </div>
        </div>

        <!-- TRANSACTIONS VIEW -->
        <div id="view-transactions" class="view-section flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-4xl mx-auto h-full flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Activity</h2>
                    <button onclick="openModal('txModal')" class="bg-blue-600 hover:bg-blue-700 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg shadow-blue-600/30 transition-all hover:scale-105 active:scale-95"><i class="fas fa-plus"></i></button>
                </div>
                <div class="glass-panel rounded-2xl flex-1 flex flex-col overflow-hidden bg-white shadow-sm">
                    <div class="p-3 border-b border-gray-100">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                            <input type="text" id="tx-search" placeholder="Search..." onkeyup="renderTransactions()" class="bg-gray-50 border border-gray-200 rounded-xl pl-9 pr-4 py-2.5 text-sm text-gray-800 w-full focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all">
                        </div>
                    </div>
                    <div id="full-tx-list" class="overflow-y-auto flex-1 divide-y divide-gray-100 pb-20"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- MOBILE NAV -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-gray-200 pb-safe z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="flex justify-around items-center h-16">
            <button onclick="router('dashboard')" id="m-nav-dashboard" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-full h-full justify-center hover:text-blue-600"><i class="fas fa-chart-pie text-lg"></i><span class="text-[10px] font-medium">Home</span></button>
            <button onclick="router('analysis')" id="m-nav-analysis" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-full h-full justify-center hover:text-blue-600"><i class="fas fa-project-diagram text-lg"></i><span class="text-[10px] font-medium">Analysis</span></button>
            <button onclick="router('accounts')" id="m-nav-accounts" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-full h-full justify-center hover:text-blue-600"><i class="fas fa-wallet text-lg"></i><span class="text-[10px] font-medium">Accounts</span></button>
            <button onclick="router('transactions')" id="m-nav-transactions" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-full h-full justify-center hover:text-blue-600"><i class="fas fa-list text-lg"></i><span class="text-[10px] font-medium">Activity</span></button>
            <button id="mob-btn-logout" class="flex flex-col items-center gap-1 text-gray-400 w-full h-full justify-center hover:text-rose-500"><i class="fas fa-sign-out-alt text-lg"></i><span class="text-[10px] font-medium">Logout</span></button>
        </div>
    </nav>

    <!-- MODAL: ADD ACCOUNT -->
    <div id="accountModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-end md:items-center justify-center sm:p-4 transition-all">
        <div class="bg-white rounded-t-2xl md:rounded-2xl border border-gray-100 p-6 w-full max-w-md shadow-2xl animate-[slideUp_0.2s_ease-out]">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Add Account</h3>
            <form onsubmit="addAccount(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Name</label>
                    <input type="text" id="accName" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-gray-900 focus:border-blue-500 outline-none transition-colors" placeholder="e.g. HDFC Bank">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Balance / Limit</label>
                    <input type="number" step="1" id="accBalance" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-gray-900 focus:border-blue-500 outline-none transition-colors" placeholder="0">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Type</label>
                    <select id="accType" onchange="toggleDebtFields()" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-gray-900 focus:border-blue-500 outline-none transition-colors">
                        <option value="cash">Cash/Bank</option>
                        <option value="investment">Investment</option>
                        <option value="property">Property</option>
                        <option value="credit">Credit Card (Debt)</option>
                        <option value="loan">Loan (Debt)</option>
                    </select>
                </div>
                <!-- Debt Fields -->
                <div id="debt-fields" class="hidden grid grid-cols-2 gap-3 p-4 bg-rose-50 rounded-xl border border-rose-100">
                    <div><label class="text-[10px] text-rose-600 font-bold uppercase">Rate (%)</label><input type="number" step="0.1" id="accRoi" class="w-full bg-white border border-rose-200 rounded p-2 text-gray-900 text-sm mt-1" placeholder="8.5"></div>
                    <div><label class="text-[10px] text-rose-600 font-bold uppercase">Months</label><input type="number" id="accTenure" class="w-full bg-white border border-rose-200 rounded p-2 text-gray-900 text-sm mt-1" placeholder="60"></div>
                    <div class="col-span-2 text-xs text-rose-600 font-medium mt-1" id="emi-preview"></div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('accountModal')" class="w-1/3 py-3 text-gray-500 hover:bg-gray-100 rounded-xl font-medium transition">Cancel</button>
                    <button type="submit" class="w-2/3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl py-3 shadow-lg shadow-blue-600/30 transition">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: ADD TRANSACTION -->
    <div id="txModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-end md:items-center justify-center sm:p-4 transition-all">
        <div class="bg-white rounded-t-2xl md:rounded-2xl border border-gray-100 p-6 w-full max-w-md shadow-2xl animate-[slideUp_0.2s_ease-out]">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Log Transaction</h3>
            <form onsubmit="addTransaction(event)" class="space-y-4">
                <input type="text" id="txDesc" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-gray-900 focus:border-blue-500 outline-none" placeholder="Description (e.g. Lunch)">
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" step="1" id="txAmount" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-gray-900 focus:border-blue-500 outline-none" placeholder="Amount">
                    <input type="date" id="txDate" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-gray-900 focus:border-blue-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <select id="txType" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-gray-900 focus:border-blue-500 outline-none"><option value="expense">Expense</option><option value="income">Income</option></select>
                    <select id="txCat" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-gray-900 focus:border-blue-500 outline-none">
                        <optgroup label="Income">
                            <option value="Salary">Salary</option><option value="Freelance">Freelance</option><option value="Business">Business</option><option value="Other Income">Other Income</option>
                        </optgroup>
                        <optgroup label="Expenses">
                            <option value="Food & Dining">Food & Dining</option><option value="Housing">Housing/Rent</option><option value="Transportation">Transportation</option><option value="Shopping">Shopping</option><option value="Entertainment">Entertainment</option><option value="Health">Health</option><option value="EMI/Debt">EMI/Debt</option><option value="Misc">Misc</option>
                        </optgroup>
                    </select>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('txModal')" class="w-1/3 py-3 text-gray-500 hover:bg-gray-100 rounded-xl font-medium transition">Cancel</button>
                    <button type="submit" class="w-2/3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl py-3 shadow-lg shadow-blue-600/30 transition">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // YOUR KEYS (INJECTED)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDVCcds_UxopRp6Vw3vL0YYzr9IjIjR6Lc",
            authDomain: "expense-and-income-faf13.firebaseapp.com",
            projectId: "expense-and-income-faf13",
            storageBucket: "expense-and-income-faf13.firebasestorage.app",
            messagingSenderId: "1278622168",
            appId: "1:1278622168:web:b6e94a4d440d17d7b75aad"
        };
        // ==========================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        let state = { accounts: [], transactions: [], history: [0] };
        let chartInst = null;
        let sankeyInst = null;
        let barChartInst = null;
        let assetPieInst = null;
        let analysisRange = '6M';

        const els = { overlay: document.getElementById('auth-overlay'), status: document.getElementById('auth-status'), name: document.getElementById('user-name'), avatar: document.getElementById('user-avatar'), nw: document.getElementById('dash-networth'), as: document.getElementById('dash-assets'), db: document.getElementById('dash-debts') };

        document.getElementById('btn-login').onclick = async () => { els.status.innerText = "Connecting..."; try { await signInWithPopup(auth, provider); } catch(e) { els.status.innerText = e.message; } };
        const logout = () => signOut(auth);
        document.getElementById('btn-logout').onclick = logout;
        document.getElementById('mob-btn-logout').onclick = logout;

        onAuthStateChanged(auth, (user) => {
            if(user) { currentUser = user; els.overlay.classList.add('hidden'); els.name.innerText = user.displayName; els.avatar.src = user.photoURL; els.avatar.classList.remove('hidden'); initSync(); } 
            else { currentUser = null; els.overlay.classList.remove('hidden'); els.status.innerText = ""; }
        });

        function initSync() {
            onSnapshot(doc(db, "users", currentUser.uid), (doc) => {
                if(doc.exists()) {
                    state = doc.data();
                    render();
                    document.getElementById('mob-sync-status').classList.add('animate-ping');
                    setTimeout(()=>document.getElementById('mob-sync-status').classList.remove('animate-ping'), 1000);
                } else { save(); }
            });
        }
        async function save() { if(currentUser) await setDoc(doc(db, "users", currentUser.uid), state); }

        window.toggleDebtFields = () => {
            const type = document.getElementById('accType').value;
            const fields = document.getElementById('debt-fields');
            if(['loan','credit'].includes(type)) fields.classList.remove('hidden'); else fields.classList.add('hidden');
        };

        function calculateEMI(p, r, n) { if(!p||!r||!n) return 0; const rm = r/12/100; return Math.round(p * rm * (Math.pow(1+rm, n) / (Math.pow(1+rm, n)-1))); }
        ['accBalance','accRoi','accTenure'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                const p = parseFloat(document.getElementById('accBalance').value)||0, r = parseFloat(document.getElementById('accRoi').value)||0, n = parseFloat(document.getElementById('accTenure').value)||0;
                if(p&&r&&n) document.getElementById('emi-preview').innerText = `Estimated EMI: ${money(calculateEMI(p,r,n))}/mo`;
            });
        });

        window.addAccount = (e) => {
            e.preventDefault();
            const type = document.getElementById('accType').value;
            let emi = 0, roi = 0, tenure = 0;
            if(['loan','credit'].includes(type)) {
                const p = parseFloat(document.getElementById('accBalance').value)||0; roi = parseFloat(document.getElementById('accRoi').value)||0; tenure = parseFloat(document.getElementById('accTenure').value)||0;
                emi = calculateEMI(p, roi, tenure);
            }
            state.accounts.push({ id: Date.now(), name: document.getElementById('accName').value, balance: parseFloat(document.getElementById('accBalance').value), type, roi, tenure, emi });
            save(); closeModal('accountModal'); e.target.reset(); document.getElementById('debt-fields').classList.add('hidden');
        };

        window.addTransaction = (e) => {
            e.preventDefault();
            state.transactions.unshift({
                id: Date.now(),
                desc: document.getElementById('txDesc').value,
                amount: parseFloat(document.getElementById('txAmount').value),
                date: document.getElementById('txDate').value,
                type: document.getElementById('txType').value,
                cat: document.getElementById('txCat').value // New Category
            });
            save(); closeModal('txModal'); e.target.reset();
        };

        window.deleteItem = (list, id) => { if(confirm('Delete?')) { state[list] = state[list].filter(i=>i.id!==id); save(); } };

        const money = (n) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(n);
        const formatDateIN = (d) => { if(!d) return ''; const [y,m,dd] = d.split('-'); return `${dd}/${m}/${y}`; };

        // Toggle Analysis Range
        window.setAnalysisRange = (range) => {
            analysisRange = range;
            if(range === '1M') {
                document.getElementById('btn-range-1m').className = "px-3 py-1 text-xs font-medium rounded-md bg-white text-blue-600 shadow-sm transition-all";
                document.getElementById('btn-range-6m').className = "px-3 py-1 text-xs font-medium rounded-md text-gray-500 hover:text-blue-600 transition-colors";
            } else {
                document.getElementById('btn-range-1m').className = "px-3 py-1 text-xs font-medium rounded-md text-gray-500 hover:text-blue-600 transition-colors";
                document.getElementById('btn-range-6m').className = "px-3 py-1 text-xs font-medium rounded-md bg-white text-blue-600 shadow-sm transition-all";
            }
            render(); 
        };

        function render() {
            // 1. Stats & Calculations
            let assets=0, debts=0, totalScheduledEMI=0;
            let assetMap = { 'Cash': 0, 'Investments': 0, 'Property': 0 };
            
            state.accounts.forEach(a => { 
                if(['cash','investment','property'].includes(a.type)) {
                    assets += a.balance;
                    if(a.type === 'cash') assetMap['Cash'] += a.balance;
                    if(a.type === 'investment') assetMap['Investments'] += a.balance;
                    if(a.type === 'property') assetMap['Property'] += a.balance;
                } else { 
                    debts += a.balance; 
                    if(a.emi) totalScheduledEMI += a.emi; 
                } 
            });
            const nw = assets - debts;
            els.nw.innerText = money(nw); els.as.innerText = money(assets); els.db.innerText = money(debts);

            // 2. Main Chart
            if(state.history[state.history.length-1]!==nw) { state.history.push(nw); if(state.history.length>12) state.history.shift(); }
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(chartInst) chartInst.destroy();
            chartInst = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: Array(state.history.length).fill(''), 
                    datasets: [{ data: state.history, borderColor: '#2563EB', backgroundColor: 'rgba(37, 99, 235, 0.1)', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 0 }] 
                }, 
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } } 
            });

            // 3. ASSET ALLOCATION PIE CHART
            const pieCtx = document.getElementById('assetPieChart').getContext('2d');
            if(assetPieInst) assetPieInst.destroy();
            assetPieInst = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Cash', 'Investments', 'Property'],
                    datasets: [{
                        data: [assetMap['Cash'], assetMap['Investments'], assetMap['Property']],
                        backgroundColor: ['#10B981', '#2563EB', '#6366F1'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '70%',
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => ` ${money(c.parsed)} (${((c.parsed/assets)*100).toFixed(1)}%)` } } }
                }
            });
            // Custom Legend
            const legendDiv = document.getElementById('asset-legend');
            const totalAssets = assets || 1;
            legendDiv.innerHTML = `
                <div class="flex items-center justify-between gap-4"><div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-[#10B981]"></span><span>Cash</span></div><span class="font-bold">${((assetMap['Cash']/totalAssets*100)||0).toFixed(0)}%</span></div>
                <div class="flex items-center justify-between gap-4"><div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-[#2563EB]"></span><span>Investments</span></div><span class="font-bold">${((assetMap['Investments']/totalAssets*100)||0).toFixed(0)}%</span></div>
                <div class="flex items-center justify-between gap-4"><div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-[#6366F1]"></span><span>Property</span></div><span class="font-bold">${((assetMap['Property']/totalAssets*100)||0).toFixed(0)}%</span></div>
            `;

            // 4. SANKEY & ANALYSIS
            const buckets = [];
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            for (let i = 5; i >= 0; i--) {
                const d = new Date(currentYear, currentMonth - i, 1);
                buckets.push({ label: `${monthNames[d.getMonth()]} ${d.getFullYear().toString().substr(-2)}`, month: d.getMonth(), year: d.getFullYear(), income: 0, expense: totalScheduledEMI }); // Auto-Add EMI
            }

            const flows = {};
            const WALLET = "Wallet";
            let sankeyTotalIn = 0, sankeyTotalOut = 0;

            state.transactions.forEach(tx => {
                const txDate = new Date(tx.date);
                const cutoff6M = new Date(buckets[0].year, buckets[0].month, 1);
                
                // Populate Bar Data
                if (txDate >= cutoff6M) {
                    const bIndex = buckets.findIndex(b => b.month === txDate.getMonth() && b.year === txDate.getFullYear());
                    if (bIndex !== -1) {
                        if (tx.type === 'income') buckets[bIndex].income += tx.amount;
                        else buckets[bIndex].expense += tx.amount;
                    }
                }

                // Populate Sankey
                let includeInSankey = false;
                if (analysisRange === '1M') {
                    if (txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear) includeInSankey = true;
                } else {
                    if (txDate >= cutoff6M) includeInSankey = true;
                }

                if (includeInSankey) {
                    const cat = tx.cat || (tx.type === 'income' ? 'Uncategorized Income' : 'Misc');
                    const amt = tx.amount;
                    if (tx.type === 'income') {
                        const key = `${cat}|${WALLET}`;
                        flows[key] = (flows[key] || 0) + amt;
                        sankeyTotalIn += amt;
                    } else {
                        const key = `${WALLET}|${cat}`;
                        flows[key] = (flows[key] || 0) + amt;
                        sankeyTotalOut += amt;
                    }
                }
            });

            // ADD EMI FLOW TO SANKEY
            const emiFlow = analysisRange === '1M' ? totalScheduledEMI : (totalScheduledEMI * 6);
            if (emiFlow > 0) {
                const emiKey = `${WALLET}|Scheduled EMI`;
                flows[emiKey] = (flows[emiKey] || 0) + emiFlow;
                sankeyTotalOut += emiFlow;
            }

            const surplus = sankeyTotalIn - sankeyTotalOut;
            if (surplus > 0) flows[`${WALLET}|Surplus`] = surplus;

            const sankeyData = Object.keys(flows).map(key => {
                const [from, to] = key.split('|');
                return { from, to, flow: flows[key] };
            });

            const sankeyCtx = document.getElementById('sankeyChart').getContext('2d');
            if(sankeyInst) sankeyInst.destroy();
            if (sankeyData.length > 0) {
                const getColor = (name) => {
                    if (name === WALLET) return '#2563EB'; 
                    if (name === 'Surplus') return '#6366F1';
                    if (name === 'Scheduled EMI') return '#F43F5E';
                    if (sankeyData.some(d => d.from === name && d.to === WALLET)) return '#10B981'; 
                    return '#F43F5E';
                };
                sankeyInst = new Chart(sankeyCtx, {
                    type: 'sankey',
                    data: {
                        datasets: [{
                            data: sankeyData,
                            colorFrom: (c) => getColor(c.raw.from),
                            colorTo: (c) => getColor(c.raw.to),
                            colorMode: 'gradient',
                            labels: { color: '#111827', font: { weight: 'bold', size: 11 }, padding: 10 },
                            nodeWidth: 20, nodePadding: 20
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: (c) => `${c.raw.from} → ${c.raw.to}: ${money(c.raw.flow)}` } } } }
                });
            } else {
                sankeyInst = new Chart(sankeyCtx, { type: 'sankey', data: { datasets: [] } }); 
            }

            const barCtx = document.getElementById('monthlyBarChart').getContext('2d');
            if(barChartInst) barChartInst.destroy();
            barChartInst = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: buckets.map(b => b.label),
                    datasets: [
                        { label: 'Income', data: buckets.map(b => b.income), backgroundColor: '#10B981', borderRadius: 4 },
                        { label: 'Expense (Inc. EMI)', data: buckets.map(b => b.expense), backgroundColor: '#F43F5E', borderRadius: 4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#6B7280' } }, y: { display: false } } }
            });

            // 5. Lists
            const ac = document.getElementById('accounts-container'); ac.innerHTML = '';
            const groups = { 'Liquidity': 'cash', 'Investments': 'investment', 'Properties': 'property', 'Loans & Credit': ['credit','loan'] };
            for(const [name, types] of Object.entries(groups)) {
                const items = state.accounts.filter(a => Array.isArray(types) ? types.includes(a.type) : a.type === types);
                if(items.length) {
                    let h = `<div class="glass-panel rounded-2xl overflow-hidden mb-4 bg-white shadow-sm"><div class="bg-gray-50 p-3 text-xs font-bold text-gray-500 uppercase pl-5 border-b border-gray-100">${name}</div><div class="divide-y divide-gray-100">`;
                    items.forEach(i => {
                        let sub = i.emi ? `<div class="text-[10px] text-rose-500 font-medium">EMI: ${money(i.emi)} @ ${i.roi}%</div>` : '';
                        h += `<div class="p-4 flex justify-between items-center hover:bg-gray-50 group"><div><div class="text-gray-900 font-medium text-sm">${i.name}</div>${sub}</div><div class="flex gap-3"><span class="text-gray-900 font-bold">${money(i.balance)}</span><button onclick="deleteItem('accounts', ${i.id})" class="text-gray-400 hover:text-rose-500"><i class="fas fa-trash"></i></button></div></div>`;
                    });
                    ac.innerHTML += h + `</div></div>`;
                }
            }

            const tc = document.getElementById('full-tx-list'); tc.innerHTML = '';
            const term = document.getElementById('tx-search').value.toLowerCase();
            state.transactions.filter(t=>t.desc.toLowerCase().includes(term)).forEach(t => {
                const isInc = t.type === 'income';
                tc.innerHTML += `<div class="flex justify-between items-center p-4 hover:bg-gray-50 transition"><div class="flex gap-3"><div class="flex flex-col"><span class="text-gray-900 text-sm font-medium">${t.desc}</span><span class="text-xs text-gray-500">${formatDateIN(t.date)} • ${t.cat||'Uncategorized'}</span></div></div><div class="flex gap-3"><span class="${isInc?'text-emerald-600':'text-gray-900'} font-bold text-sm">${isInc?'+':'-'}${money(t.amount)}</span><button onclick="deleteItem('transactions', ${t.id})" class="text-gray-400 hover:text-rose-500"><i class="fas fa-times"></i></button></div></div>`;
            });
        }

        window.router = (v) => {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.querySelectorAll('.nav-item, .desktop-nav-item').forEach(e => e.classList.remove('active'));
            if(document.getElementById('d-nav-'+v)) document.getElementById('d-nav-'+v).classList.add('active');
            if(document.getElementById('m-nav-'+v)) document.getElementById('m-nav-'+v).classList.add('active');
        };
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        document.getElementById('txDate').valueAsDate = new Date();
        router('dashboard');
    </script>
</body>
</html>
