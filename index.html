<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FFFFFF">
    <title>Cash Flow | Titanium X</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- DESIGN SYSTEM --- */
        :root { --bg-body: #F3F4F6; --primary: #4F46E5; --primary-soft: #E0E7FF; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: #1F2937; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        
        /* Layout */
        .app-layout { display: flex; height: 100dvh; width: 100vw; overflow: hidden; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #E5E7EB; display: none; flex-direction: column; z-index: 40; }
        .main-content { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        
        /* Views */
        .view-container { padding: 20px; padding-bottom: 140px; max-width: 1000px; margin: 0 auto; display: none; }
        .view-container.active { display: block; animation: fadeUp 0.3s ease-out; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile Dock */
        .mobile-dock {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            border-top: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between;
            padding: 12px 16px 28px 16px; 
            z-index: 50;
            overflow-x: auto; /* Allow scrolling if many items */
        }
        .dock-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #9CA3AF; font-size: 10px; font-weight: 600; min-width: 55px; }
        .dock-item.active { color: var(--primary); }

        /* UI Elements */
        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #F3F4F6; margin-bottom: 16px; }
        .input-field { background: #F9FAFB; border: 1px solid #E5E7EB; color: #111827; padding: 12px; border-radius: 12px; width: 100%; outline: none; }
        .input-field:focus { border-color: var(--primary); ring: 2px solid var(--primary-soft); }

        /* Floating Add Button */
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 8px 20px -4px rgba(79, 70, 229, 0.5); z-index: 45; }
        
        /* Modals (Fixed Z-Index) */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: flex-end; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%); transition: transform 0.3s; max-height: 90vh; overflow-y: auto; }
        .modal-overlay.open .modal-content { transform: translateY(0); }

        /* Desktop Tweaks */
        @media (min-width: 768px) {
            .sidebar { display: flex; }
            .mobile-dock { display: none; }
            .fab { display: none; }
            .view-container { padding: 40px; }
            .modal-overlay { align-items: center; }
            .modal-content { border-radius: 24px; transform: scale(0.95); opacity: 0; }
            .modal-overlay.open .modal-content { transform: scale(1); opacity: 1; }
        }
        
        /* Loading Screen */
        #loading-screen { position: fixed; inset: 0; background: white; z-index: 200; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
        <p class="text-sm font-bold text-gray-400">Loading your data...</p>
    </div>

    <div class="app-layout">
        
        <aside class="sidebar">
            <div class="p-6 border-b border-gray-100 flex items-center gap-3 font-bold text-lg text-slate-800">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white"><i class="fas fa-wallet"></i></div> Cash Flow
            </div>
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button onclick="router('dashboard')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-500 hover:bg-indigo-50 hover:text-indigo-600"><i class="fas fa-home w-5"></i> Dashboard</button>
                <button onclick="router('activity')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-500 hover:bg-indigo-50 hover:text-indigo-600"><i class="fas fa-list-ul w-5"></i> Activity</button>
                <button onclick="router('accounts')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-500 hover:bg-indigo-50 hover:text-indigo-600"><i class="fas fa-university w-5"></i> Accounts</button>
                <button onclick="router('debts')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-500 hover:bg-indigo-50 hover:text-indigo-600"><i class="fas fa-file-invoice-dollar w-5"></i> Debts</button>
                <button onclick="router('investments')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-500 hover:bg-indigo-50 hover:text-indigo-600"><i class="fas fa-chart-line w-5"></i> Investments</button>
                <button onclick="router('calendar')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-500 hover:bg-indigo-50 hover:text-indigo-600"><i class="fas fa-calendar w-5"></i> Calendar</button>
                <button onclick="router('profile')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-gray-500 hover:bg-indigo-50 hover:text-indigo-600"><i class="fas fa-user-circle w-5"></i> Profile</button>
            </nav>
            <div class="p-4 border-t border-gray-100">
                <button onclick="openTxModal()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-md hover:bg-indigo-700 transition">Add Transaction</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="md:hidden sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-gray-100 px-4 py-4 flex justify-between items-center">
                <h1 class="text-lg font-bold text-slate-900" id="header-title">Dashboard</h1>
                <div onclick="router('profile')" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-600"><i class="fas fa-user"></i></div>
            </header>

            <div id="view-dashboard" class="view-container active">
                <div class="card bg-slate-900 text-white border-0">
                    <div class="text-gray-400 text-xs font-bold uppercase mb-1">Total Net Worth</div>
                    <div class="text-4xl font-bold tracking-tight" id="dash-networth">Loading...</div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="card p-4">
                        <div class="text-xs text-gray-400 font-bold uppercase">Assets</div>
                        <div class="text-xl font-bold text-emerald-600" id="dash-assets">...</div>
                    </div>
                    <div class="card p-4">
                        <div class="text-xs text-gray-400 font-bold uppercase">Liabilities</div>
                        <div class="text-xl font-bold text-rose-600" id="dash-debts">...</div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="font-bold text-gray-900 mb-4">Allocation</h3>
                    <div class="relative h-48 w-full flex justify-center"><canvas id="dashPieChart"></canvas></div>
                </div>
            </div>

            <div id="view-activity" class="view-container">
                <h2 class="text-2xl font-bold mb-4">Transactions</h2>
                <div class="mb-4 relative">
                    <i class="fas fa-search absolute left-4 top-3.5 text-gray-400"></i>
                    <input type="text" id="search-tx" class="input-field pl-10" placeholder="Search..." onkeyup="renderActivity()">
                </div>
                <div id="activity-list" class="space-y-3 pb-20"></div>
            </div>

            <div id="view-accounts" class="view-container">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Accounts</h2>
                    <button onclick="openModal('modal-account')" class="bg-slate-900 text-white w-8 h-8 rounded-lg flex items-center justify-center"><i class="fas fa-plus"></i></button>
                </div>
                <div id="accounts-list" class="space-y-3"></div>
            </div>

            <div id="view-profile" class="view-container">
                <h2 class="text-2xl font-bold mb-6">Settings</h2>
                <div class="card space-y-4">
                    <button onclick="exportCSV()" class="w-full text-left p-3 rounded-xl hover:bg-gray-50 font-semibold text-sm">ðŸ“„ Export CSV</button>
                    <button onclick="backupData()" class="w-full text-left p-3 rounded-xl hover:bg-gray-50 font-semibold text-sm">ðŸ’¾ Backup Data</button>
                    <label class="w-full text-left p-3 rounded-xl hover:bg-gray-50 font-semibold text-sm block cursor-pointer">
                        ðŸ“‚ Restore Data <input type="file" hidden onchange="restoreData(this)">
                    </label>
                    <div class="h-px bg-gray-100"></div>
                    <button onclick="logout()" class="w-full text-left p-3 rounded-xl hover:bg-red-50 text-red-600 font-bold text-sm">Sign Out</button>
                </div>
            </div>
            
            <div id="view-debts" class="view-container"><h2 class="text-2xl font-bold">Debts</h2><div id="debt-list"></div></div>
            <div id="view-investments" class="view-container"><h2 class="text-2xl font-bold">Investments</h2><div id="invest-list"></div></div>
            <div id="view-calendar" class="view-container"><h2 class="text-2xl font-bold">Calendar</h2><div class="card p-4 text-center text-gray-500">Coming Soon</div></div>
            <div id="view-future" class="view-container"><h2 class="text-2xl font-bold">Future</h2><div class="card p-4 text-center text-gray-500">Coming Soon</div></div>
            <div id="view-reports" class="view-container"><h2 class="text-2xl font-bold">Reports</h2><div class="card p-4 text-center text-gray-500">Coming Soon</div></div>

        </main>
    </div>

    <button onclick="openTxModal()" class="fab md:hidden"><i class="fas fa-plus"></i></button>

    <nav class="mobile-dock md:hidden">
        <button onclick="router('dashboard')" id="m-nav-dashboard" class="dock-item"><i class="fas fa-home"></i>Home</button>
        <button onclick="router('activity')" id="m-nav-activity" class="dock-item"><i class="fas fa-list"></i>Act</button>
        <button onclick="router('accounts')" id="m-nav-accounts" class="dock-item"><i class="fas fa-wallet"></i>Acc</button>
        <button onclick="router('debts')" id="m-nav-debts" class="dock-item"><i class="fas fa-file-invoice"></i>Debt</button>
        <button onclick="router('profile')" id="m-nav-profile" class="dock-item"><i class="fas fa-user"></i>Pro</button>
    </nav>

    <div id="modal-tx" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Transaction</h3>
                <button onclick="closeModal('modal-tx')" class="text-gray-400 text-xl">&times;</button>
            </div>
            <form onsubmit="saveTx(event)" class="space-y-4">
                <input type="hidden" id="txId">
                <input id="txDesc" class="input-field" placeholder="Description" required>
                <div class="flex gap-2">
                    <input id="txAmount" type="number" class="input-field" placeholder="0.00" required>
                    <input id="txDate" type="date" class="input-field" required>
                </div>
                <div class="flex gap-2">
                    <select id="txType" class="input-field" onchange="toggleTxFields()">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                        <option value="transfer">Transfer</option>
                    </select>
                    <select id="txCat" class="input-field">
                        <option value="General">General</option>
                        <option value="Food">Food</option>
                        <option value="Transport">Transport</option>
                        <option value="Housing">Housing</option>
                        <option value="Salary">Salary</option>
                    </select>
                </div>
                <select id="txAcc" class="input-field" required></select>
                <select id="txToAcc" class="input-field hidden"></select>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl">Save</button>
            </form>
        </div>
    </div>

    <div id="modal-account" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Add Account</h3>
            <form onsubmit="addAccount(event)" class="space-y-4">
                <input id="accName" class="input-field" placeholder="Name" required>
                <input id="accBalance" type="number" class="input-field" placeholder="Balance" required>
                <select id="accType" class="input-field">
                    <option value="cash">Cash/Bank</option>
                    <option value="investment">Investment</option>
                    <option value="credit">Debt/Loan</option>
                </select>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl">Save</button>
                <button type="button" onclick="closeModal('modal-account')" class="w-full text-gray-500 py-2 font-bold">Cancel</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PASTE KEYS BELOW ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVCcds_UxopRp6Vw3vL0YYzr9IjIjR6Lc",
            authDomain: "expense-and-income-faf13.firebaseapp.com",
            projectId: "expense-and-income-faf13",
            storageBucket: "expense-and-income-faf13.firebasestorage.app",
            messagingSenderId: "1278622168",
            appId: "1:1278622168:web:b6e94a4d440d17d7b75aad"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let state = { accounts: [], transactions: [] };
        let pieChart = null;

        // --- AUTH ---
        // Global logout function
        window.logout = async () => {
            if(confirm("Sign out?")) await signOut(auth);
        };

        onAuthStateChanged(auth, u => {
            if(u) {
                document.getElementById('loading-screen').classList.add('hidden'); // Hide loading if logged in
                document.getElementById('auth-overlay').classList.add('hidden');
                init(u);
            } else {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('auth-overlay').classList.remove('hidden');
            }
        });

        document.getElementById('btn-login').onclick = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } 
            catch(e) { alert(e.message); }
        };

        function init(user) {
            // Subscribe to DB
            onSnapshot(doc(db, "users", user.uid), s => {
                if(s.exists()) { 
                    state = s.data(); 
                    if(!state.accounts) state.accounts = []; // Safety check
                    if(!state.transactions) state.transactions = []; // Safety check
                    render(); 
                } else { 
                    save(); // Create new doc if missing
                }
            });
        }

        async function save() { if(auth.currentUser) await setDoc(doc(db, "users", auth.currentUser.uid), state); }

        // --- ROUTER ---
        window.router = (v) => {
            document.querySelectorAll('.view-container').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.getElementById('header-title').innerText = v.charAt(0).toUpperCase() + v.slice(1);
            
            // Highlight Mobile Dock
            document.querySelectorAll('.dock-item').forEach(e => e.classList.remove('active'));
            const activeBtn = document.getElementById('m-nav-'+v);
            if(activeBtn) activeBtn.classList.add('active');

            render(); // Refresh UI
        };

        // --- UI HELPERS ---
        const money = n => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(n);
        
        window.openModal = id => {
            document.getElementById(id).classList.add('open');
            if(id === 'modal-tx') {
                document.getElementById('txDate').valueAsDate = new Date();
                const sel = document.getElementById('txAcc');
                sel.innerHTML = state.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
                document.getElementById('txToAcc').innerHTML = sel.innerHTML;
            }
        };
        window.closeModal = id => document.getElementById(id).classList.remove('open');
        window.openTxModal = () => window.openModal('modal-tx');

        window.toggleTxFields = () => {
            const t = document.getElementById('txType').value;
            document.getElementById('txToAcc').classList.toggle('hidden', t !== 'transfer');
        };

        // --- LOGIC ---
        window.addAccount = e => {
            e.preventDefault();
            const a = {
                id: Date.now(),
                name: document.getElementById('accName').value,
                balance: parseFloat(document.getElementById('accBalance').value),
                type: document.getElementById('accType').value
            };
            state.accounts.push(a);
            save();
            closeModal('modal-account');
            e.target.reset();
        };

        window.saveTx = e => {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('txAmount').value);
            const type = document.getElementById('txType').value;
            const accId = parseInt(document.getElementById('txAcc').value);
            
            // Balance Update
            const acc = state.accounts.find(a => a.id === accId);
            if(acc) {
                if(type === 'income') acc.balance += amt;
                if(type === 'expense') acc.balance -= amt;
                if(type === 'transfer') {
                    acc.balance -= amt;
                    const toAcc = state.accounts.find(a => a.id === parseInt(document.getElementById('txToAcc').value));
                    if(toAcc) toAcc.balance += amt;
                }
            }

            const tx = {
                id: Date.now(),
                desc: document.getElementById('txDesc').value,
                amount: amt,
                date: document.getElementById('txDate').value,
                type: type,
                cat: document.getElementById('txCat').value,
                accId: accId
            };
            
            state.transactions.unshift(tx);
            save();
            closeModal('modal-tx');
            e.target.reset();
        };

        window.deleteItem = (type, id) => {
            if(confirm("Delete item?")) {
                if(type === 'tx') state.transactions = state.transactions.filter(t => t.id !== id);
                if(type === 'acc') state.accounts = state.accounts.filter(a => a.id !== id);
                save();
            }
        };

        // --- RENDERERS ---
        function render() {
            const v = document.querySelector('.view-container.active').id;

            // 1. DASHBOARD
            if(v === 'view-dashboard') {
                let assets=0, debts=0;
                state.accounts.forEach(a => {
                    if(['cash','investment','property'].includes(a.type)) assets += a.balance;
                    else debts += a.balance;
                });
                document.getElementById('dash-networth').innerText = money(assets - debts);
                document.getElementById('dash-assets').innerText = money(assets);
                document.getElementById('dash-debts').innerText = money(debts);

                // Pie Chart
                const ctx = document.getElementById('dashPieChart').getContext('2d');
                if(pieChart) pieChart.destroy();
                pieChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Assets', 'Debts'],
                        datasets: [{ data: [assets, debts], backgroundColor: ['#10B981', '#F43F5E'], borderWidth: 0 }]
                    },
                    options: { responsive: true, cutout: '70%', plugins: { legend: { position: 'bottom' } } }
                });
            }

            // 2. ACTIVITY
            if(v === 'view-activity') {
                const list = document.getElementById('activity-list');
                const term = document.getElementById('search-tx').value.toLowerCase();
                const filtered = state.transactions.filter(t => t.desc.toLowerCase().includes(term));
                
                list.innerHTML = filtered.length ? filtered.map(t => `
                    <div class="card p-4 flex justify-between items-center">
                        <div class="flex gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-100 text-gray-500">
                                <i class="fas ${t.type==='income'?'fa-arrow-down':'fa-arrow-up'}"></i>
                            </div>
                            <div>
                                <div class="font-bold text-sm">${t.desc}</div>
                                <div class="text-xs text-gray-400">${t.date} â€¢ ${t.cat}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold ${t.type==='income'?'text-emerald-600':'text-rose-600'}">
                                ${t.type==='income'?'+':'-'}${money(t.amount)}
                            </div>
                            <button onclick="deleteItem('tx', ${t.id})" class="text-xs text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('') : '<div class="text-center text-gray-400 mt-10">No transactions found.</div>';
            }

            // 3. ACCOUNTS
            if(v === 'view-accounts') {
                const list = document.getElementById('accounts-list');
                list.innerHTML = state.accounts.map(a => `
                    <div class="card flex justify-between items-center p-4">
                        <div>
                            <div class="font-bold text-slate-800">${a.name}</div>
                            <div class="text-xs text-gray-400 uppercase">${a.type}</div>
                        </div>
                        <div class="flex gap-3 items-center">
                            <span class="font-bold text-lg">${money(a.balance)}</span>
                            <button onclick="deleteItem('acc', ${a.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            }
            
            // 4. DEBTS & INVESTMENTS (Simple Lists for now)
            if(v === 'view-debts') {
                const debts = state.accounts.filter(a => ['credit','loan'].includes(a.type));
                document.getElementById('debt-list').innerHTML = debts.map(a => `<div class="card p-4 flex justify-between"><span>${a.name}</span><span class="font-bold">${money(a.balance)}</span></div>`).join('');
            }
            if(v === 'view-investments') {
                const invs = state.accounts.filter(a => a.type === 'investment');
                document.getElementById('invest-list').innerHTML = invs.map(a => `<div class="card p-4 flex justify-between"><span>${a.name}</span><span class="font-bold">${money(a.balance)}</span></div>`).join('');
            }
        }
        
        // CSV Export
        window.exportCSV = () => {
            const rows = [["Date","Desc","Amount","Type","Category"], ...state.transactions.map(t=>[t.date,t.desc,t.amount,t.type,t.cat])];
            const csv = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "data.csv"; link.click();
        };

        // Backup/Restore
        window.backupData = () => {
            const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const link = document.createElement("a"); link.href = data; link.download = "backup.json"; link.click();
        };
        window.restoreData = (input) => {
            const reader = new FileReader();
            reader.onload = e => { state = JSON.parse(e.target.result); save(); location.reload(); };
            reader.readAsText(input.files[0]);
        };
        window.nukeData = () => { if(confirm("Reset everything?")) { state={accounts:[],transactions:[]}; save(); location.reload(); } };

        // Init Router
        router('dashboard');

    </script>
</body>
</html>
