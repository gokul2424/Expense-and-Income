<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#F8FAFC">
    <title>Cash Flow | Titanium</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-sankey"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { --bg-body: #F8FAFC; --primary: #4F46E5; --primary-soft: #EEF2FF; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); color: #1E293B; -webkit-tap-highlight-color: transparent; }
        
        /* UI Elements */
        .neo-card { background: white; border-radius: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02); border: 1px solid #F1F5F9; transition: transform 0.2s ease; }
        .neo-input { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 16px; padding: 16px; font-weight: 600; color: #0F172A; width: 100%; transition: all 0.2s; outline: none; }
        .neo-input:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-soft); }

        /* View Transitions */
        .view-section { display: none; padding-bottom: 140px; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Navigation */
        .nav-dock { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); border-radius: 24px; margin: 0 16px 16px 16px; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .desktop-nav-item:hover { background: white; color: #334155; }
        .desktop-nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        
        /* Headers & Meters */
        .date-header { position: sticky; top: 0; background: rgba(248, 250, 252, 0.95); backdrop-filter: blur(5px); z-index: 10; padding: 12px 0; font-size: 11px; font-weight: 800; color: #94A3B8; text-transform: uppercase; letter-spacing: 0.05em; }
        .meter-container { height: 8px; background: #F1F5F9; border-radius: 99px; overflow: hidden; position: relative; }
        .meter-fill { height: 100%; border-radius: 99px; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Privacy Mode */
        body.privacy-active .money-val { filter: blur(6px); transition: filter 0.3s; user-select: none; }
        .money-val { transition: filter 0.3s; }
        
        /* AI Insight Card */
        .ai-gradient { background: linear-gradient(135deg, #FFF 0%, #F5F3FF 100%); border: 1px solid #E0E7FF; }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-slate-50 text-slate-800">

    <div id="auth-overlay" class="fixed inset-0 z-50 bg-white/80 backdrop-blur-xl flex flex-col items-center justify-center p-6 transition-opacity duration-300">
        <div class="bg-white p-10 rounded-[40px] max-w-sm w-full text-center shadow-2xl border border-slate-100">
            <div class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-xl shadow-indigo-200 rotate-3">
                <i class="fas fa-wallet text-white text-4xl"></i>
            </div>
            <h1 class="text-4xl font-extrabold text-slate-900 mb-2 tracking-tight">Cash Flow.</h1>
            <p class="text-slate-500 mb-10 font-medium">Titanium Edition.</p>
            <button id="btn-login" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl hover:scale-[1.02] transition-transform flex items-center justify-center gap-3 shadow-lg">
                <i class="fab fa-google text-lg"></i> Continue with Google
            </button>
            <p id="auth-status" class="text-xs text-rose-500 mt-6 min-h-[1rem] font-medium"></p>
        </div>
    </div>

    <aside class="hidden md:flex flex-col w-72 bg-[#F8FAFC] border-r border-slate-200/60 z-20">
        <div class="p-8">
            <div class="flex items-center gap-3 text-2xl font-bold text-slate-900">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-lg shadow-lg shadow-indigo-200"><i class="fas fa-wallet"></i></div>
                Cash Flow
            </div>
        </div>
        <nav class="flex-1 px-6 space-y-1">
            <button onclick="router('dashboard')" id="d-nav-dashboard" class="desktop-nav-item w-full flex items-center px-4 py-3.5 text-sm gap-4 rounded-xl font-semibold text-slate-500 transition-all"><i class="fas fa-home w-5"></i> Home</button>
            <button onclick="router('analysis')" id="d-nav-analysis" class="desktop-nav-item w-full flex items-center px-4 py-3.5 text-sm gap-4 rounded-xl font-semibold text-slate-500 transition-all"><i class="fas fa-chart-pie w-5"></i> Analysis</button>
            <button onclick="router('debts')" id="d-nav-debts" class="desktop-nav-item w-full flex items-center px-4 py-3.5 text-sm gap-4 rounded-xl font-semibold text-slate-500 transition-all"><i class="fas fa-file-invoice-dollar w-5"></i> Debts</button>
            <button onclick="router('accounts')" id="d-nav-accounts" class="desktop-nav-item w-full flex items-center px-4 py-3.5 text-sm gap-4 rounded-xl font-semibold text-slate-500 transition-all"><i class="fas fa-university w-5"></i> Accounts</button>
            <button onclick="router('transactions')" id="d-nav-transactions" class="desktop-nav-item w-full flex items-center px-4 py-3.5 text-sm gap-4 rounded-xl font-semibold text-slate-500 transition-all"><i class="fas fa-list-ul w-5"></i> Activity</button>
        </nav>
        <div class="p-6">
            <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-3 mb-4">
                    <img id="user-avatar" src="" class="w-10 h-10 rounded-full bg-slate-200 hidden ring-2 ring-white">
                    <div class="overflow-hidden">
                        <div id="user-name" class="text-sm font-bold text-slate-900 truncate">User</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Titanium</div>
                    </div>
                </div>
                <div class="flex gap-2 mb-2">
                    <button onclick="togglePrivacy()" id="btn-privacy" class="flex-1 py-2 text-xs font-bold text-slate-600 bg-slate-50 hover:bg-slate-100 rounded-xl transition flex items-center justify-center gap-1"><i class="fas fa-eye-slash"></i> Hide</button>
                    <button onclick="exportCSV()" class="flex-1 py-2 text-xs font-bold text-slate-600 bg-slate-50 hover:bg-slate-100 rounded-xl transition flex items-center justify-center gap-1"><i class="fas fa-download"></i> CSV</button>
                </div>
                <button id="btn-logout" class="w-full py-2 text-xs font-bold text-rose-600 bg-rose-50 hover:bg-rose-100 rounded-xl transition">Sign Out</button>
            </div>
        </div>
    </aside>

    <main class="flex-1 relative flex flex-col h-full overflow-hidden bg-[#F8FAFC]">
        <header class="md:hidden flex items-center justify-between p-6 pb-2 bg-[#F8FAFC] z-30 sticky top-0 backdrop-blur-md">
            <div>
                <h1 class="text-2xl font-extrabold text-slate-900" id="greeting">Hello!</h1>
                <p class="text-slate-500 text-sm font-medium">Financial Overview</p>
            </div>
            <div class="flex gap-2">
                <button onclick="togglePrivacy()" id="mob-btn-privacy" class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm border border-slate-100 text-slate-600"><i class="fas fa-eye"></i></button>
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm border border-slate-100 relative">
                    <div id="mob-sync-status" class="w-2.5 h-2.5 rounded-full bg-emerald-500 absolute top-0 right-0 m-1"></div>
                    <i class="fas fa-cloud text-slate-400 text-xs"></i>
                </div>
                <button id="mob-btn-logout" class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm border border-slate-100 text-rose-500"><i class="fas fa-power-off text-sm"></i></button>
            </div>
        </header>

        <div id="view-dashboard" class="view-section flex-1 overflow-y-auto p-6 md:p-10 scroll-smooth">
            <div class="max-w-6xl mx-auto space-y-6">
                <div id="smart-insights" class="hidden neo-card ai-gradient p-5 flex items-start gap-4 animate-[fadeIn_0.5s_ease-out]">
                    <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 shrink-0"><i class="fas fa-robot"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-900 text-sm">Smart Insight</h4>
                        <p id="insight-text" class="text-sm text-slate-600 mt-1 leading-relaxed">Analyzing your data...</p>
                    </div>
                </div>

                <div class="relative overflow-hidden rounded-[32px] bg-slate-900 text-white shadow-2xl shadow-slate-200 p-8">
                    <div class="absolute -top-24 -right-24 w-72 h-72 bg-indigo-600 opacity-20 rounded-full blur-3xl"></div>
                    <div class="absolute bottom-[-50px] left-[-50px] w-64 h-64 bg-emerald-500 opacity-10 rounded-full blur-3xl"></div>
                    <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                        <div>
                            <div class="flex items-center gap-2 text-slate-400 text-sm font-bold mb-2 uppercase tracking-wider">
                                <i class="fas fa-shield-alt"></i> Total Net Worth
                            </div>
                            <div class="text-4xl md:text-6xl font-extrabold tracking-tight"><span class="money-val" id="dash-networth">...</span></div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="openTxModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-bold text-sm hover:bg-indigo-500 transition shadow-lg shadow-indigo-900/50 flex items-center gap-2">
                                <i class="fas fa-plus"></i> Add Tx
                            </button>
                        </div>
                    </div>
                </div>

                <div class="neo-card p-6 md:px-8">
                    <div class="flex justify-between items-end mb-3">
                        <div><h3 class="font-bold text-slate-900">Monthly Burn Rate</h3><p class="text-xs text-slate-500">Expenses vs Income (This Month)</p></div>
                        <div class="text-right"><div id="burn-percent" class="text-2xl font-bold text-slate-900">0%</div></div>
                    </div>
                    <div class="meter-container"><div id="burn-bar" class="meter-fill bg-indigo-600" style="width: 0%"></div></div>
                    <div class="flex justify-between mt-2 text-xs font-bold text-slate-400">
                        <span class="money-val" id="burn-expense">Exp: 0</span>
                        <span class="money-val" id="burn-income">Inc: 0</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="neo-card p-6 flex flex-col justify-center group hover:border-emerald-200 transition">
                        <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center mb-4 text-xl"><i class="fas fa-arrow-up rotate-45"></i></div>
                        <div class="text-slate-400 text-xs font-bold uppercase tracking-wider">Assets</div>
                        <div class="text-2xl md:text-3xl font-extrabold text-slate-900 mt-1 money-val" id="dash-assets">...</div>
                    </div>
                    <div class="neo-card p-6 flex flex-col justify-center group hover:border-rose-200 transition">
                        <div class="w-12 h-12 bg-rose-50 text-rose-600 rounded-2xl flex items-center justify-center mb-4 text-xl"><i class="fas fa-arrow-down rotate-45"></i></div>
                        <div class="text-slate-400 text-xs font-bold uppercase tracking-wider">Liabilities</div>
                        <div class="text-2xl md:text-3xl font-extrabold text-slate-900 mt-1 money-val" id="dash-debts">...</div>
                    </div>
                </div>

                <div class="neo-card p-6 md:p-8">
                    <div class="flex justify-between items-center mb-6">
                        <div><h3 class="font-bold text-slate-900 text-xl">Growth</h3></div>
                        <span class="bg-slate-100 text-slate-500 px-4 py-1.5 rounded-full text-xs font-bold">1 Year</span>
                    </div>
                    <div class="chart-wrapper p-2" style="height: 250px;"><canvas id="mainChart"></canvas></div>
                </div>
            </div>
        </div>

        <div id="view-analysis" class="view-section flex-1 overflow-y-auto p-6 md:p-10">
            <div class="max-w-6xl mx-auto space-y-8">
                <div class="flex justify-between items-center">
                    <div><h2 class="text-3xl font-extrabold text-slate-900">Analysis</h2><p class="text-slate-500 font-medium">Flows & Allocation</p></div>
                </div>

                <div id="recurring-section" class="hidden">
                     <h3 class="font-bold text-slate-900 text-lg mb-4">Detected Subscriptions</h3>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="recurring-list"></div>
                </div>

                <div class="neo-card p-8 border-indigo-100 border-2">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div><h3 class="font-bold text-slate-900 text-lg">Money Flow</h3></div>
                        <div class="flex bg-slate-100 rounded-xl p-1 gap-1">
                            <button onclick="setAnalysisRange('1M')" id="btn-range-1m" class="filter-btn inactive">1M</button>
                            <button onclick="setAnalysisRange('6M')" id="btn-range-6m" class="filter-btn active">6M</button>
                            <button onclick="setAnalysisRange('1Y')" id="btn-range-1y" class="filter-btn inactive">1Y</button>
                        </div>
                    </div>
                    <div class="chart-wrapper" style="height: 400px;"><canvas id="sankeyChart"></canvas></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="neo-card p-6">
                        <h3 class="font-bold text-slate-900 text-lg mb-6">Monthly Trend</h3>
                        <div class="chart-wrapper" style="height: 250px;"><canvas id="monthlyBarChart"></canvas></div>
                    </div>
                    <div class="neo-card p-6">
                        <h3 class="font-bold text-slate-900 text-lg mb-6">Allocation</h3>
                        <div class="flex items-center justify-center">
                            <div style="height: 200px; width: 200px;"><canvas id="assetPieChart"></canvas></div>
                            <div id="asset-legend" class="ml-8 space-y-3 text-sm font-medium text-slate-600"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-debts" class="view-section flex-1 overflow-y-auto p-6 md:p-10">
            <div class="max-w-6xl mx-auto space-y-8">
                <div><h2 class="text-3xl font-extrabold text-slate-900">Debts</h2><p class="text-slate-500 font-medium">Liability Tracking</p></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="neo-card p-6">
                        <h3 class="font-bold text-slate-900 text-lg mb-1">True Cost</h3>
                        <div class="chart-wrapper" style="height: 250px;"><canvas id="debtSplitChart"></canvas></div>
                    </div>
                    <div class="neo-card p-6">
                        <h3 class="font-bold text-slate-900 text-lg mb-1">Composition</h3>
                        <div class="chart-wrapper" style="height: 250px;"><canvas id="debtPieChart"></canvas></div>
                    </div>
                </div>
                <div id="debt-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <div id="view-accounts" class="view-section flex-1 overflow-y-auto p-6 md:p-10">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8 sticky top-0 bg-[#F8FAFC]/95 backdrop-blur z-10 py-2">
                    <div><h2 class="text-3xl font-extrabold text-slate-900">Accounts</h2><p class="text-slate-500 font-medium">Net Worth Components</p></div>
                    <button onclick="openModal('accountModal')" class="bg-slate-900 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-xl hover:scale-105 transition-transform"><i class="fas fa-plus"></i></button>
                </div>
                <div id="accounts-container" class="space-y-6"></div>
            </div>
        </div>

        <div id="view-transactions" class="view-section flex-1 overflow-y-auto p-6 md:p-10">
            <div class="max-w-4xl mx-auto h-full flex flex-col">
                <div class="flex justify-between items-center mb-8">
                    <div><h2 class="text-3xl font-extrabold text-slate-900">Activity</h2><p class="text-slate-500 font-medium">Tap to Edit</p></div>
                    <button onclick="openTxModal()" class="bg-slate-900 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-xl hover:scale-105 transition-transform"><i class="fas fa-plus"></i></button>
                </div>
                <div class="neo-card flex-1 flex flex-col overflow-hidden border-0 shadow-none bg-transparent md:bg-white md:shadow-lg md:border">
                    <div class="p-4 md:border-b border-slate-100 bg-white rounded-2xl md:rounded-none mb-4 md:mb-0 shadow-sm md:shadow-none">
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-4 text-slate-400"></i>
                            <input type="text" id="tx-search" placeholder="Search transactions..." onkeyup="renderTransactions()" class="neo-input pl-11 bg-slate-50">
                        </div>
                    </div>
                    <div id="full-tx-list" class="overflow-y-auto flex-1 p-0 md:p-2 space-y-2 md:space-y-0"></div>
                </div>
            </div>
        </div>
    </main>

    <nav class="md:hidden fixed bottom-4 left-4 right-4 z-40">
        <div class="nav-dock flex justify-between items-center px-6 py-4">
            <button onclick="router('dashboard')" id="m-nav-dashboard" class="nav-item flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-home text-xl"></i></button>
            <button onclick="router('analysis')" id="m-nav-analysis" class="nav-item flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-chart-pie text-xl"></i></button>
            <div class="relative -top-10">
                <button onclick="openTxModal()" class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-white text-2xl shadow-xl shadow-indigo-300 hover:scale-105 transition-transform border-[6px] border-[#F8FAFC]"><i class="fas fa-plus"></i></button>
            </div>
            <button onclick="router('debts')" id="m-nav-debts" class="nav-item flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-receipt text-xl"></i></button>
            <button onclick="router('accounts')" id="m-nav-accounts" class="nav-item flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-wallet text-xl"></i></button>
        </div>
    </nav>

    <div id="accountModal" class="fixed inset-0 z-50 hidden bg-slate-900/60 backdrop-blur-sm flex items-end md:items-center justify-center sm:p-4 transition-all">
        <div class="bg-white rounded-t-[32px] md:rounded-[32px] p-8 w-full max-w-md shadow-2xl animate-[slideUp_0.3s_ease-out] max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-slate-900 mb-6">Add Account</h3>
            <form onsubmit="addAccount(event)" class="space-y-5">
                <input type="text" id="accName" required class="neo-input" placeholder="Account Name (e.g. HDFC)">
                <input type="number" step="1" id="accBalance" required class="neo-input" placeholder="Current Balance">
                <div class="relative">
                    <select id="accType" onchange="toggleDebtFields()" class="neo-input appearance-none"><option value="cash">Cash / Bank</option><option value="investment">Investment</option><option value="property">Property</option><option value="credit">Credit Card (Debt)</option><option value="loan">Loan (Debt)</option></select>
                    <i class="fas fa-chevron-down absolute right-4 top-5 text-slate-400 pointer-events-none"></i>
                </div>
                <div id="debt-fields" class="hidden grid grid-cols-2 gap-4 p-4 bg-slate-50 rounded-2xl border border-slate-100">
                    <div class="col-span-2"><label class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Start Date</label><input type="date" id="accStartDate" class="neo-input mt-1 p-3 text-sm text-slate-600"></div>
                    <div><label class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Interest %</label><input type="number" step="0.1" id="accRoi" class="neo-input mt-1 p-3 text-sm" placeholder="8.5"></div>
                    <div><label class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Months</label><input type="number" id="accTenure" class="neo-input mt-1 p-3 text-sm" placeholder="60"></div>
                    <div class="col-span-2 text-xs text-indigo-600 font-bold mt-1 text-center bg-indigo-50 py-2 rounded-lg" id="emi-preview">EMI: 0</div>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal('accountModal')" class="flex-1 py-4 text-slate-500 font-bold bg-slate-100 rounded-2xl hover:bg-slate-200 transition">Cancel</button>
                    <button type="submit" class="flex-1 py-4 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="txModal" class="fixed inset-0 z-50 hidden bg-slate-900/60 backdrop-blur-sm flex items-end md:items-center justify-center sm:p-4 transition-all">
        <div class="bg-white rounded-t-[32px] md:rounded-[32px] p-8 w-full max-w-md shadow-2xl animate-[slideUp_0.3s_ease-out] max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-slate-900 mb-6" id="txModalTitle">Transaction</h3>
            <form onsubmit="saveTransaction(event)" class="space-y-5">
                <input type="hidden" id="txId">
                <input type="text" id="txDesc" required class="neo-input" placeholder="Description (e.g. Grocery)">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" step="1" id="txAmount" required class="neo-input" placeholder="0.00">
                    <input type="date" id="txDate" required class="neo-input text-slate-500 p-3">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="relative">
                        <select id="txType" onchange="toggleTxFields()" class="neo-input appearance-none">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                            <option value="transfer">Transfer</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-5 text-slate-400 pointer-events-none"></i>
                    </div>
                    <div class="relative">
                        <select id="txCat" class="neo-input appearance-none">
                            <optgroup label="Common"><option value="Food & Dining">Food</option><option value="Transport">Transport</option><option value="Shopping">Shopping</option></optgroup>
                            <optgroup label="Bills"><option value="Housing">Housing</option><option value="Utilities">Utilities</option><option value="EMI">EMI</option><option value="Subscription">Subscription</option></optgroup>
                            <optgroup label="Income"><option value="Salary">Salary</option><option value="Business">Business</option></optgroup>
                            <optgroup label="Other"><option value="Transfer">Transfer</option><option value="Misc">Misc</option></optgroup>
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-5 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase tracking-wider ml-2 mb-1 block" id="lbl-from-acc">Account</label>
                        <div class="relative"><select id="txAccount" required class="neo-input appearance-none"></select><i class="fas fa-chevron-down absolute right-4 top-5 text-slate-400 pointer-events-none"></i></div>
                    </div>
                    <div id="div-to-acc" class="hidden">
                        <label class="text-[10px] text-slate-400 font-bold uppercase tracking-wider ml-2 mb-1 block">To Account</label>
                        <div class="relative"><select id="txToAccount" class="neo-input appearance-none"></select><i class="fas fa-chevron-down absolute right-4 top-5 text-slate-400 pointer-events-none"></i></div>
                    </div>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal('txModal')" class="flex-1 py-4 text-slate-500 font-bold bg-slate-100 rounded-2xl hover:bg-slate-200 transition">Cancel</button>
                    <button type="submit" class="flex-1 py-4 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const config = { currency: 'INR', locale: 'en-IN' };

        // --- FIREBASE CONFIG (INSERT YOUR KEYS HERE) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVCcds_UxopRp6Vw3vL0YYzr9IjIjR6Lc",
            authDomain: "expense-and-income-faf13.firebaseapp.com",
            projectId: "expense-and-income-faf13",
            storageBucket: "expense-and-income-faf13.firebasestorage.app",
            messagingSenderId: "1278622168",
            appId: "1:1278622168:web:b6e94a4d440d17d7b75aad"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        let state = { accounts: [], transactions: [], history: [0] };
        let chartInst=null, sankeyInst=null, barChartInst=null, assetPieInst=null, debtSplitInst=null, debtPieInst=null, analysisRange='6M';
        let isPrivacyMode = false;

        const els = { overlay: document.getElementById('auth-overlay'), status: document.getElementById('auth-status'), name: document.getElementById('user-name'), avatar: document.getElementById('user-avatar'), nw: document.getElementById('dash-networth'), as: document.getElementById('dash-assets'), db: document.getElementById('dash-debts') };

        // --- AUTH ---
        document.getElementById('btn-login').onclick = async () => { els.status.innerText = "Connecting..."; try { await signInWithPopup(auth, provider); } catch(e) { els.status.innerText = e.message; } };
        document.getElementById('btn-logout').onclick = () => { if(confirm("Sign out?")) signOut(auth); };
        if(document.getElementById('mob-btn-logout')) document.getElementById('mob-btn-logout').onclick = () => { if(confirm("Sign out?")) signOut(auth); };

        onAuthStateChanged(auth, (user) => {
            if(user) { currentUser = user; els.overlay.classList.add('hidden', 'opacity-0'); setTimeout(()=>els.overlay.classList.add('hidden'),300); els.name.innerText = user.displayName; els.avatar.src = user.photoURL; els.avatar.classList.remove('hidden'); initSync(); setGreeting(); } 
            else { currentUser = null; els.overlay.classList.remove('hidden'); setTimeout(()=>els.overlay.classList.remove('opacity-0'),10); els.status.innerText = ""; }
        });

        function setGreeting() {
            const h = new Date().getHours();
            const g = h < 12 ? "Good Morning" : h < 18 ? "Good Afternoon" : "Good Evening";
            if(document.getElementById('greeting')) document.getElementById('greeting').innerText = g;
        }

        // --- DB ---
        function initSync() {
            onSnapshot(doc(db, "users", currentUser.uid), (doc) => {
                if(doc.exists()) { state = doc.data(); render(); } else { save(); }
            });
        }
        async function save() { if(currentUser) await setDoc(doc(db, "users", currentUser.uid), state); }

        // --- HELPERS ---
        // Enhanced money function that wraps content in a span for blur capability
        const money = (n) => `<span class="money-val">${new Intl.NumberFormat(config.locale, { style: 'currency', currency: config.currency, maximumFractionDigits: 0 }).format(n)}</span>`;
        const formatDateIN = (d) => { if(!d) return ''; const [y,m,dd] = d.split('-'); return `${dd}/${m}/${y}`; };
        
        window.exportCSV = () => {
            if(!state.transactions.length) return alert("No transactions.");
            const headers = ["Date", "Description", "Amount", "Type", "Category", "Account", "To Account"];
            const rows = state.transactions.map(t => [t.date, t.desc, t.amount, t.type, t.cat, t.accName, t.toAccName||''].join(","));
            const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows].join("\n");
            const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", `cashflow_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        window.togglePrivacy = () => {
            isPrivacyMode = !isPrivacyMode;
            document.body.classList.toggle('privacy-active', isPrivacyMode);
            const icon = isPrivacyMode ? '<i class="fas fa-eye"></i> Show' : '<i class="fas fa-eye-slash"></i> Hide';
            const mIcon = isPrivacyMode ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
            document.getElementById('btn-privacy').innerHTML = icon;
            document.getElementById('mob-btn-privacy').innerHTML = mIcon;
        };

        const getCategoryIcon = (cat) => {
            const map = { 'Food & Dining':'utensils', 'Transport':'car', 'Shopping':'bag-shopping', 'Housing':'house', 'Utilities':'bolt', 'EMI':'file-invoice', 'Salary':'money-bill-wave', 'Business':'briefcase', 'Transfer':'right-left', 'Misc':'layer-group', 'Subscription':'repeat' };
            return map[cat] || 'circle';
        }

        // --- LOGIC ---
        window.toggleDebtFields = () => { const t=document.getElementById('accType').value; const f=document.getElementById('debt-fields'); if(['loan','credit'].includes(t)) f.classList.remove('hidden'); else f.classList.add('hidden'); };
        window.toggleTxFields = () => {
            const t = document.getElementById('txType').value;
            const to = document.getElementById('div-to-acc');
            const lbl = document.getElementById('lbl-from-acc');
            if(t === 'transfer') { to.classList.remove('hidden'); lbl.innerText = "From Account"; } 
            else { to.classList.add('hidden'); lbl.innerText = "Account"; }
        };

        function calculateEMI(p, r, n) { if(!p||!r||!n) return 0; const rm = r/12/100; return Math.round(p * rm * (Math.pow(1+rm, n) / (Math.pow(1+rm, n)-1))); }
        ['accBalance','accRoi','accTenure'].forEach(id => { document.getElementById(id).addEventListener('input', () => { const p = parseFloat(document.getElementById('accBalance').value)||0, r = parseFloat(document.getElementById('accRoi').value)||0, n = parseFloat(document.getElementById('accTenure').value)||0; if(p&&r&&n) document.getElementById('emi-preview').innerHTML = `Estimated EMI: ${money(calculateEMI(p,r,n))}/mo`; }); });

        window.addAccount = (e) => {
            e.preventDefault();
            const type = document.getElementById('accType').value;
            let emi = 0, roi = 0, tenure = 0, startDate = '';
            if(['loan','credit'].includes(type)) {
                const p = parseFloat(document.getElementById('accBalance').value)||0; roi = parseFloat(document.getElementById('accRoi').value)||0; tenure = parseFloat(document.getElementById('accTenure').value)||0;
                emi = calculateEMI(p, roi, tenure); startDate = document.getElementById('accStartDate').value;
            }
            state.accounts.push({ id: Date.now(), name: document.getElementById('accName').value, balance: parseFloat(document.getElementById('accBalance').value), type, roi, tenure, emi, startDate });
            save(); closeModal('accountModal'); e.target.reset(); document.getElementById('debt-fields').classList.add('hidden');
        };

        window.openTxModal = () => {
            document.getElementById('txModalTitle').innerText = "New Transaction";
            document.getElementById('txId').value = ""; // Clear ID
            document.getElementById('txDesc').value = "";
            document.getElementById('txAmount').value = "";
            document.getElementById('txDate').valueAsDate = new Date();
            openModal('txModal');
        };

        window.editTransaction = (id) => {
            const tx = state.transactions.find(t => t.id === id);
            if(!tx) return;
            document.getElementById('txModalTitle').innerText = "Edit Transaction";
            document.getElementById('txId').value = tx.id;
            document.getElementById('txDesc').value = tx.desc;
            document.getElementById('txAmount').value = tx.amount;
            document.getElementById('txDate').value = tx.date;
            document.getElementById('txType').value = tx.type;
            document.getElementById('txCat').value = tx.cat;
            updateAccountSelect();
            document.getElementById('txAccount').value = tx.accId || "";
            if(tx.type === 'transfer') document.getElementById('txToAccount').value = tx.toAccId || "";
            toggleTxFields();
            openModal('txModal');
        };

        window.saveTransaction = (e) => {
            e.preventDefault();
            const id = document.getElementById('txId').value;
            const isEdit = !!id;
            const amount = parseFloat(document.getElementById('txAmount').value);
            const type = document.getElementById('txType').value;
            const accId = parseFloat(document.getElementById('txAccount').value);
            const toAccId = type === 'transfer' ? parseFloat(document.getElementById('txToAccount').value) : null;
            const modifyBalance = (aId, amt, direction) => {
                const a = state.accounts.find(x => x.id === aId);
                if(a) {
                    const isDebt = ['credit','loan'].includes(a.type);
                    if(!isDebt) a.balance += (amt * direction);
                    else a.balance -= (amt * direction);
                }
                return a ? a.name : 'Unknown';
            };
            if(isEdit) {
                const oldTx = state.transactions.find(t => t.id == id);
                if(oldTx) {
                    if(oldTx.type === 'income') modifyBalance(oldTx.accId, oldTx.amount, -1);
                    else if(oldTx.type === 'expense') modifyBalance(oldTx.accId, oldTx.amount, 1);
                    else if(oldTx.type === 'transfer') { modifyBalance(oldTx.accId, oldTx.amount, 1); modifyBalance(oldTx.toAccId, oldTx.amount, -1); }
                    state.transactions = state.transactions.filter(t => t.id != id);
                }
            }
            let accName = '', toAccName = '';
            if(type === 'income') accName = modifyBalance(accId, amount, 1);
            else if(type === 'expense') accName = modifyBalance(accId, amount, -1);
            else if(type === 'transfer') { accName = modifyBalance(accId, amount, -1); toAccName = modifyBalance(toAccId, amount, 1); }

            const newTx = { id: isEdit ? parseFloat(id) : Date.now(), desc: document.getElementById('txDesc').value, amount: amount, date: document.getElementById('txDate').value, type: type, cat: document.getElementById('txCat').value, accId: accId, accName: accName, toAccId: toAccId, toAccName: toAccName };
            state.transactions.unshift(newTx);
            state.transactions.sort((a,b) => new Date(b.date) - new Date(a.date));
            save(); closeModal('txModal'); e.target.reset();
        };

        window.deleteItem = (list, id) => { 
            if(confirm('Delete this item?')) {
                if(list === 'transactions') {
                    const t = state.transactions.find(x => x.id === id);
                    if(t) {
                        const a = state.accounts.find(x => x.id === t.accId);
                        if(a) {
                            const isDebt = ['credit','loan'].includes(a.type);
                            if(t.type === 'income') a.balance -= t.amount * (isDebt?-1:1); 
                            else if(t.type === 'expense') a.balance += t.amount * (isDebt?-1:1);
                            else if(t.type === 'transfer') { a.balance += t.amount * (isDebt?-1:1); const dest = state.accounts.find(x => x.id === t.toAccId); if(dest) dest.balance -= t.amount * (['credit','loan'].includes(dest.type)?-1:1); }
                        }
                    }
                }
                state[list] = state[list].filter(i=>i.id!==id); save(); 
            } 
        };
        window.setAnalysisRange = (range) => { analysisRange = range; render(); };

        function updateAccountSelect() {
            const select = document.getElementById('txAccount'); 
            const toSelect = document.getElementById('txToAccount');
            const genOpts = () => {
                let html = '';
                const assets = state.accounts.filter(a => ['cash', 'investment', 'property'].includes(a.type));
                const debts = state.accounts.filter(a => ['credit', 'loan'].includes(a.type));
                if(assets.length) { html+=`<optgroup label="Assets">`+assets.map(a=>`<option value="${a.id}">${a.name}</option>`).join('')+`</optgroup>`; }
                if(debts.length) { html+=`<optgroup label="Credit/Loan">`+debts.map(a=>`<option value="${a.id}">${a.name}</option>`).join('')+`</optgroup>`; }
                return html;
            };
            const h = genOpts(); select.innerHTML = h; toSelect.innerHTML = h;
        }

        // --- INTELLIGENCE ENGINE ---
        function generateInsights(assets, debts, burnPct, topCat) {
            const card = document.getElementById('smart-insights');
            const txt = document.getElementById('insight-text');
            const debtRatio = assets > 0 ? (debts / assets) * 100 : 0;
            let msg = "";

            if (burnPct > 90) msg = "‚ö†Ô∏è <b>High Spend Alert:</b> You've used over 90% of your monthly income. Consider cutting back on discretionary spending.";
            else if (debtRatio > 50) msg = "üìâ <b>Debt Alert:</b> Your liabilities are over 50% of your assets. Focus on paying down high-interest debt.";
            else if (topCat) msg = `üìä <b>Spending Trend:</b> Your highest expense category this month is <b>${topCat.name}</b> (${money(topCat.amt)}).`;
            else if (burnPct < 40 && burnPct > 0) msg = "üåü <b>Great Job!</b> You are saving more than 60% of your income this month. Keep it up!";
            else msg = "üí° <b>Tip:</b> Log more transactions to get personalized financial advice.";

            txt.innerHTML = msg;
            card.classList.remove('hidden');
        }

        function renderRecurrings() {
            // Simple logic: same amount and description > 1 time
            const counts = {};
            state.transactions.filter(t=>t.type==='expense').forEach(t => {
                const k = `${t.desc}|${t.amount}`;
                if(!counts[k]) counts[k] = { count:0, t:t };
                counts[k].count++;
            });
            const recurs = Object.values(counts).filter(x => x.count >= 2);
            const div = document.getElementById('recurring-list');
            const sect = document.getElementById('recurring-section');
            
            if(recurs.length > 0) {
                sect.classList.remove('hidden');
                div.innerHTML = recurs.map(r => `
                    <div class="bg-white border border-slate-100 p-4 rounded-2xl flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center"><i class="fas fa-repeat text-xs"></i></div>
                            <div><div class="font-bold text-sm text-slate-800">${r.t.desc}</div><div class="text-[10px] text-slate-400">Detected monthly</div></div>
                        </div>
                        <div class="font-bold text-slate-900">${money(r.t.amount)}</div>
                    </div>
                `).join('');
            } else sect.classList.add('hidden');
        }

        // --- RENDER ---
        function render() {
            updateAccountSelect();
            ['1M','6M','1Y'].forEach(r => { const btn=document.getElementById(`btn-range-${r.toLowerCase()}`); if(btn) btn.className = r===analysisRange ? "filter-btn active" : "filter-btn inactive"; });

            let assets=0, debts=0, totalScheduledEMI=0;
            let assetMap = { 'Cash': 0, 'Investments': 0, 'Property': 0 };
            let totalDebtPrincipal=0, totalEstimatedInterest=0, debtCompositionLabels=[], debtCompositionData=[], debtListHTML="";

            state.accounts.forEach(a => { 
                if(['cash','investment','property'].includes(a.type)) { 
                    assets+=a.balance; 
                    if(a.type==='cash') assetMap['Cash']+=a.balance; if(a.type==='investment') assetMap['Investments']+=a.balance; if(a.type==='property') assetMap['Property']+=a.balance; 
                } else { 
                    debts+=a.balance; totalDebtPrincipal += a.balance;
                    if(a.emi) {
                        totalScheduledEMI+=a.emi;
                        let monthsElapsed = 0;
                        if(a.startDate) { const start = new Date(a.startDate); const now = new Date(); monthsElapsed = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth()); }
                        const remainingTenure = Math.max(0, (a.tenure || 0) - monthsElapsed);
                        const totalRemainingPayable = a.emi * remainingTenure;
                        totalEstimatedInterest += Math.max(0, totalRemainingPayable - a.balance);
                        const payoffDate = new Date(); payoffDate.setMonth(payoffDate.getMonth() + remainingTenure);
                        const principalPercent = totalRemainingPayable > 0 ? (a.balance / totalRemainingPayable) * 100 : 0;
                        debtListHTML += `<div class="neo-card p-5 border-l-4 border-rose-500 mb-3 hover:shadow-lg transition"><div class="flex justify-between items-start mb-2"><div><h4 class="font-bold text-slate-900 text-lg">${a.name}</h4><span class="text-xs font-semibold bg-rose-100 text-rose-600 px-2 py-0.5 rounded">EMI: ${money(a.emi)}</span></div><div class="text-right"><div class="text-xs text-slate-400 uppercase font-bold">Liability</div><div class="font-bold text-slate-900 text-xl">${money(totalRemainingPayable)}</div></div></div><div class="w-full bg-slate-100 h-2 rounded-full mt-2 mb-1 overflow-hidden flex"><div class="bg-indigo-500 h-full" style="width: ${principalPercent}%"></div><div class="bg-rose-400 h-full" style="width: ${100-principalPercent}%"></div></div><div class="flex justify-between text-[10px] text-slate-500 mb-3"><span class="flex items-center gap-1">Principal: ${money(a.balance)}</span><span class="flex items-center gap-1">Interest: ${money(totalRemainingPayable - a.balance)}</span></div><div class="grid grid-cols-2 gap-4 pt-2 border-t border-slate-50 text-xs"><div><span class="text-slate-400 block">Rate</span><span class="font-bold text-slate-700">${a.roi}%</span></div><div class="text-right"><span class="text-slate-400 block">Free Date</span><span class="font-bold text-emerald-600">${payoffDate.toLocaleDateString('en-IN', {month:'short', year:'numeric'})}</span></div></div></div>`;
                    } else {
                        debtListHTML += `<div class="neo-card p-5 border-l-4 border-orange-400 mb-3 hover:shadow-lg transition"><div class="flex justify-between items-center"><h4 class="font-bold text-slate-900">${a.name}</h4><div class="font-bold text-slate-900 text-lg">${money(a.balance)}</div></div></div>`;
                    }
                    debtCompositionLabels.push(a.name); debtCompositionData.push(a.balance);
                } 
            });
            const nw = assets - debts;
            els.nw.innerHTML = money(nw); els.as.innerHTML = money(assets); els.db.innerHTML = money(debts);

            // METRICS & AI
            const now = new Date();
            const thisMonthTx = state.transactions.filter(t => { const d = new Date(t.date); return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear(); });
            const mInc = thisMonthTx.filter(t => t.type === 'income').reduce((a,b) => a+b.amount, 0);
            const mExp = thisMonthTx.filter(t => t.type === 'expense').reduce((a,b) => a+b.amount, 0);
            const burnPct = mInc > 0 ? Math.min(100, (mExp / mInc) * 100) : 0;
            
            // Calc Top Category
            const cats = {};
            thisMonthTx.filter(t=>t.type==='expense').forEach(t => { cats[t.cat] = (cats[t.cat]||0) + t.amount; });
            let topCat = null;
            Object.keys(cats).forEach(c => { if(!topCat || cats[c] > topCat.amt) topCat = {name:c, amt:cats[c]}; });

            generateInsights(assets, debts, burnPct, topCat);
            renderRecurrings();

            document.getElementById('burn-percent').innerText = `${burnPct.toFixed(0)}%`;
            document.getElementById('burn-bar').style.width = `${burnPct}%`;
            document.getElementById('burn-bar').className = `meter-fill ${burnPct < 50 ? 'bg-emerald-500' : burnPct < 80 ? 'bg-orange-400' : 'bg-rose-500'}`;
            document.getElementById('burn-expense').innerHTML = `Out: ${money(mExp)}`;
            document.getElementById('burn-income').innerHTML = `In: ${money(mInc)}`;

            // CHARTS
            if(state.history[state.history.length-1]!==nw) { state.history.push(nw); if(state.history.length>12) state.history.shift(); }
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(chartInst) chartInst.destroy();
            chartInst = new Chart(ctx, { type: 'line', data: { labels: Array(state.history.length).fill(''), datasets: [{ data: state.history, borderColor: '#4F46E5', backgroundColor: (c)=>{const gradient=c.chart.ctx.createLinearGradient(0,0,0,200);gradient.addColorStop(0,'rgba(79,70,229,0.2)');gradient.addColorStop(1,'rgba(79,70,229,0)');return gradient;}, borderWidth: 3, fill: true, tension: 0.4, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } } });

            const pieCtx = document.getElementById('assetPieChart').getContext('2d');
            if(assetPieInst) assetPieInst.destroy();
            assetPieInst = new Chart(pieCtx, { type: 'doughnut', data: { labels: ['Cash', 'Inv', 'Prop'], datasets: [{ data: [assetMap['Cash'], assetMap['Investments'], assetMap['Property']], backgroundColor: ['#10B981', '#3B82F6', '#6366F1'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } } });
            const totalAssets=assets||1; document.getElementById('asset-legend').innerHTML=`<div class="flex justify-between items-center w-full"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500"></span><span>Cash</span></div><span class="font-bold">${((assetMap['Cash']/totalAssets)*100).toFixed(0)}%</span></div><div class="flex justify-between items-center w-full"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span><span>Inv</span></div><span class="font-bold">${((assetMap['Investments']/totalAssets)*100).toFixed(0)}%</span></div><div class="flex justify-between items-center w-full"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-indigo-500"></span><span>Prop</span></div><span class="font-bold">${((assetMap['Property']/totalAssets)*100).toFixed(0)}%</span></div>`;

            if(document.getElementById('view-debts').classList.contains('active')) {
                const debtSplitCtx = document.getElementById('debtSplitChart').getContext('2d');
                if(debtSplitInst) debtSplitInst.destroy();
                debtSplitInst = new Chart(debtSplitCtx, { type: 'bar', data: { labels: ['Liability'], datasets: [ { label: 'Principal', data: [totalDebtPrincipal], backgroundColor: '#4F46E5', borderRadius: 8 }, { label: 'Interest', data: [totalEstimatedInterest], backgroundColor: '#F43F5E', borderRadius: 8 } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, grid: {display:false} }, y: { stacked: true, display: false } }, plugins: { legend: { position: 'bottom' } } } });
                const debtPieCtx = document.getElementById('debtPieChart').getContext('2d');
                if(debtPieInst) debtPieInst.destroy();
                debtPieInst = new Chart(debtPieCtx, { type: 'doughnut', data: { labels: debtCompositionLabels, datasets: [{ data: debtCompositionData, backgroundColor: ['#F43F5E', '#F97316', '#EAB308', '#84CC16', '#06B6D4'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: {size: 10} } } } } });
                document.getElementById('debt-list-container').innerHTML = debtListHTML || '<div class="col-span-2 text-center text-slate-400 py-10">No active debts found.</div>';
            }

            const buckets=[]; const monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; const cm=new Date().getMonth(); const cy=new Date().getFullYear();
            const rangeMonths = analysisRange === '1Y' ? 11 : 5;
            for(let i=rangeMonths;i>=0;i--){ const d=new Date(cy,cm-i,1); buckets.push({label:`${monthNames[d.getMonth()]}`, month:d.getMonth(), year:d.getFullYear(), income:0, expense:0}); }
            
            state.accounts.forEach(a => { if(a.emi && a.emi > 0) buckets.forEach(b => { const bucketDate = new Date(b.year, b.month, 1); const loanStart = a.startDate ? new Date(a.startDate) : new Date(0); loanStart.setDate(1); if (bucketDate >= loanStart) b.expense += a.emi; }); });

            const flows={}; const WALLET="Wallet"; let si=0, so=0;
            state.transactions.forEach(tx=>{
                if(tx.type === 'transfer') return;
                const txDate=new Date(tx.date); 
                const bi=buckets.findIndex(b=>b.month===txDate.getMonth()&&b.year===txDate.getFullYear());
                if(bi!==-1){ if(tx.type==='income') buckets[bi].income+=tx.amount; else buckets[bi].expense+=tx.amount; }
                let inc=false;
                if(analysisRange==='1M'){ if(txDate.getMonth()===cm && txDate.getFullYear()===cy) inc=true; } 
                else if(analysisRange==='6M'){ if(bi !== -1 && bi >= buckets.length - 6) inc=true; }
                else { if(bi !== -1) inc=true; }
                if(inc){
                    const cat=tx.cat||(tx.type==='income'?'Uncat Inc':'Misc'); const amt=tx.amount;
                    if(tx.type==='income'){ const k=`${cat}|${WALLET}`; flows[k]=(flows[k]||0)+amt; si+=amt; }
                    else { const k=`${WALLET}|${cat}`; flows[k]=(flows[k]||0)+amt; so+=amt; }
                }
            });
            
            let totalSankeyEMI = 0;
            buckets.forEach(b => {
                let inRange = false;
                if(analysisRange === '1M' && b.month === cm && b.year === cy) inRange = true;
                else if(analysisRange === '6M' && buckets.indexOf(b) >= buckets.length - 6) inRange = true;
                else if(analysisRange === '1Y') inRange = true;
                if(inRange) {
                    state.accounts.forEach(a => { if(a.emi && a.emi > 0) { const bDate = new Date(b.year, b.month, 1); const lStart = a.startDate ? new Date(a.startDate) : new Date(0); lStart.setDate(1); if(bDate >= lStart) totalSankeyEMI += a.emi; } });
                }
            });
            if(totalSankeyEMI>0) { const k=`${WALLET}|EMI`; flows[k]=(flows[k]||0)+totalSankeyEMI; so+=totalSankeyEMI; }
            const surplus=si-so; if(surplus>0) flows[`${WALLET}|Savings`]=surplus;
            
            const sankeyData=Object.keys(flows).map(k=>{const[f,t]=k.split('|');return{from:f,to:t,flow:flows[k]};});
            const sankeyCtx=document.getElementById('sankeyChart').getContext('2d');
            if(sankeyInst) sankeyInst.destroy();
            const getColor = (name) => { if(!name) return '#ccc'; if(name===WALLET) return '#2563EB'; if(name==='Savings') return '#10B981'; if(name==='EMI') return '#F43F5E'; if(sankeyData.some(d=>d.from===name&&d.to===WALLET)) return '#3B82F6'; return '#F43F5E'; };
            sankeyInst = new Chart(sankeyCtx, { type: 'sankey', data: { datasets: [{ data: sankeyData, colorFrom: (c)=>c.dataset.data[c.dataIndex]?getColor(c.dataset.data[c.dataIndex].from):'#ccc', colorTo: (c)=>c.dataset.data[c.dataIndex]?getColor(c.dataset.data[c.dataIndex].to):'#ccc', colorMode: 'gradient', labels: { color: '#111827', font: { weight: 'bold', size: 11 }, padding: 10 }, nodeWidth: 20, nodePadding: 20 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: (c) => `${c.raw.from} ‚Üí ${c.raw.to}: ${money(c.raw.flow)}` } } } } });

            const barCtx = document.getElementById('monthlyBarChart').getContext('2d');
            if(barChartInst) barChartInst.destroy();
            barChartInst = new Chart(barCtx, { type: 'bar', data: { labels: buckets.map(b => b.label), datasets: [{ label: 'Inc', data: buckets.map(b => b.income), backgroundColor: '#10B981', borderRadius: 4 }, { label: 'Exp', data: buckets.map(b => b.expense), backgroundColor: '#F43F5E', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#6B7280' } }, y: { display: false } } } });

            const ac=document.getElementById('accounts-container'); ac.innerHTML='';
            const groups={ 'Liquidity': 'cash', 'Investments': 'investment', 'Real Estate': 'property', 'Debt / Loans': ['credit','loan'] };
            for(const[name,types] of Object.entries(groups)){
                const items=state.accounts.filter(a=>Array.isArray(types)?types.includes(a.type):a.type===types);
                if(items.length){
                    let h=`<div class="neo-card p-5 mb-4"><h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-50 pb-2">${name}</h4><div class="space-y-4">`;
                    items.forEach(i=>{
                        let sub=i.emi?`<div class="text-[10px] text-rose-500 font-bold bg-rose-50 px-2 py-0.5 rounded-full inline-block mt-1">EMI: ${money(i.emi)}</div>`:'';
                        if(i.startDate) sub += ` <span class="text-[10px] text-slate-400 ml-1">Since: ${formatDateIN(i.startDate)}</span>`;
                        h+=`<div class="flex justify-between items-center group"><div><div class="font-bold text-slate-800">${i.name}</div>${sub}</div><div class="flex items-center gap-3"><span class="font-bold text-slate-900">${money(i.balance)}</span><button onclick="deleteItem('accounts', ${i.id})" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-300 hover:text-rose-500 hover:bg-rose-50 transition"><i class="fas fa-trash"></i></button></div></div>`;
                    });
                    ac.innerHTML+=h+`</div></div>`;
                }
            }

            const tc=document.getElementById('full-tx-list'); tc.innerHTML='';
            const term=document.getElementById('tx-search').value.toLowerCase();
            const filteredTx = state.transactions.filter(t=>t.desc.toLowerCase().includes(term));
            
            if(filteredTx.length === 0) tc.innerHTML = `<div class="flex flex-col items-center justify-center h-48 text-slate-400"><i class="fas fa-receipt text-3xl mb-2 opacity-50"></i><p class="text-sm font-medium">No transactions found</p></div>`;
            else {
                let lastDate = null;
                filteredTx.forEach(t => {
                    const isInc=t.type==='income'; const isTrf=t.type==='transfer';
                    const txDate = new Date(t.date); const today = new Date(); const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                    let dateStr = formatDateIN(t.date);
                    if(txDate.toDateString() === today.toDateString()) dateStr = "Today";
                    else if(txDate.toDateString() === yesterday.toDateString()) dateStr = "Yesterday";
                    else dateStr = txDate.toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short' });
                    if(dateStr !== lastDate) { tc.innerHTML += `<div class="date-header px-4 md:px-2">${dateStr}</div>`; lastDate = dateStr; }

                    let iconColor = isTrf ? 'bg-slate-100 text-slate-600' : isInc ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600';
                    let amountColor = isTrf ? 'text-slate-900' : isInc ? 'text-emerald-600' : 'text-slate-900';
                    let sign = isTrf ? '' : isInc ? '+' : '-';
                    let icon = getCategoryIcon(t.cat);
                    let subText = isTrf ? `${t.accName} <i class="fas fa-arrow-right text-[10px]"></i> ${t.toAccName}` : t.accName;

                    tc.innerHTML+=`
                    <div onclick="editTransaction(${t.id})" class="cursor-pointer flex justify-between items-center p-3 mb-2 bg-white md:bg-slate-50 md:hover:bg-white rounded-2xl border border-transparent md:border-slate-100 hover:shadow-md transition mx-2 md:mx-0 group">
                        <div class="flex gap-4 items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${iconColor}"><i class="fas fa-${icon} text-sm"></i></div>
                            <div>
                                <div class="font-bold text-slate-800 text-sm">${t.desc}</div>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <div class="text-[10px] text-slate-400 font-bold bg-slate-100 px-1.5 py-0.5 rounded">${t.cat || 'Misc'}</div>
                                    <span class="text-[10px] text-slate-400 font-medium">${subText}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3 items-center">
                            <span class="font-bold text-sm ${amountColor}">${sign}${money(t.amount)}</span>
                            <button onclick="event.stopPropagation(); deleteItem('transactions', ${t.id})" class="text-slate-200 hover:text-rose-500 transition px-2"><i class="fas fa-times"></i></button>
                        </div>
                    </div>`;
                });
            }
        }

        window.router=(v)=>{document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));document.getElementById('view-'+v).classList.add('active');document.querySelectorAll('.nav-item, .desktop-nav-item').forEach(e=>e.classList.remove('active'));if(document.getElementById('d-nav-'+v))document.getElementById('d-nav-'+v).classList.add('active');if(document.getElementById('m-nav-'+v))document.getElementById('m-nav-'+v).classList.add('active');render();};
        window.openModal=(id)=>document.getElementById(id).classList.remove('hidden');window.closeModal=(id)=>document.getElementById(id).classList.add('hidden');
        document.getElementById('txDate').valueAsDate=new Date(); router('dashboard');
    </script>
</body>
</html>
