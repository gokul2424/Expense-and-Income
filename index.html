<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FFFFFF">
    <title>Cash Flow | Aero</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-sankey"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- AERO DESIGN SYSTEM --- */
        :root { 
            --bg-body: #F3F4F6; 
            --primary: #4F46E5; 
            --primary-soft: #E0E7FF; 
            --surface: #FFFFFF;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body); 
            color: #1F2937; 
            -webkit-tap-highlight-color: transparent; 
            overflow: hidden; /* Prevent body scroll, handle in main */
        }
        
        /* Layout Engine */
        .app-layout { display: flex; height: 100dvh; width: 100vw; overflow: hidden; }
        .sidebar { width: 280px; background: white; border-right: 1px solid #E5E7EB; display: none; flex-direction: column; z-index: 50; }
        .main-content { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; scroll-behavior: smooth; }
        
        /* Responsive View Padding */
        .view-container { 
            padding: 20px; 
            padding-bottom: 120px; /* Space for Mobile Dock */
            max-width: 1000px; 
            margin: 0 auto; 
            display: none; /* Hidden by default */
        }
        .view-container.active { display: block; animation: fadeUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile Dock */
        .mobile-dock {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px);
            border-top: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-around;
            padding: 12px 0 24px 0; /* Extra bottom padding for iPhone Home bar */
            z-index: 50;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.02);
        }
        .dock-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #9CA3AF; font-size: 10px; font-weight: 600; width: 60px; transition: color 0.2s; }
        .dock-item i { font-size: 20px; margin-bottom: 2px; transition: transform 0.2s; }
        .dock-item.active { color: var(--primary); }
        .dock-item.active i { transform: translateY(-2px); }

        /* Cards */
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #F3F4F6; margin-bottom: 16px; }
        
        /* Inputs */
        .input-field { background: #F9FAFB; border: 1px solid #E5E7EB; color: #111827; padding: 12px 16px; border-radius: 12px; width: 100%; font-size: 14px; outline: none; transition: border 0.2s; }
        .input-field:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px var(--primary-soft); }

        /* Floating Add Button (FAB) */
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.4); z-index: 40; transition: transform 0.2s; }
        .fab:active { transform: scale(0.9); }

        /* Desktop Adjustments */
        @media (min-width: 768px) {
            .sidebar { display: flex; }
            .mobile-dock { display: none; }
            .fab { display: none; } /* Use desktop header button */
            .view-container { padding: 40px; }
        }

        /* Utilities */
        .money { font-variant-numeric: tabular-nums; letter-spacing: -0.02em; }
        .text-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; color: #9CA3AF; }
        
        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: flex-end; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 100%; max-width: 450px; border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 90vh; overflow-y: auto; }
        .modal-overlay.open .modal-content { transform: translateY(0); }
        @media (min-width: 768px) { .modal-overlay { align-items: center; } .modal-content { border-radius: 24px; width: 400px; transform: scale(0.95); opacity: 0; } .modal-overlay.open .modal-content { transform: scale(1); opacity: 1; } }

        /* Calendar */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-cell { aspect-ratio: 1; border-radius: 10px; border: 1px solid #F3F4F6; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: #6B7280; flex-direction: column; }
        .cal-cell.active { background: #F0FDF4; border-color: #BBF7D0; color: #15803D; }
        .cal-dot { width: 4px; height: 4px; border-radius: 50%; background: #EF4444; margin-top: 2px; }
    </style>
</head>
<body>

    <div class="app-layout">
        
        <aside class="sidebar">
            <div class="p-8 border-b border-gray-100">
                <div class="flex items-center gap-3 text-xl font-extrabold text-slate-900 tracking-tight">
                    <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white"><i class="fas fa-bolt text-sm"></i></div>
                    Cash Flow
                </div>
            </div>
            <nav class="flex-1 overflow-y-auto p-4 space-y-1">
                <button onclick="router('dashboard')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-xl text-gray-500 hover:bg-gray-50 hover:text-indigo-600 transition"><i class="fas fa-home w-5"></i> Home</button>
                <button onclick="router('debts')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-xl text-gray-500 hover:bg-gray-50 hover:text-indigo-600 transition"><i class="fas fa-file-invoice-dollar w-5"></i> Debts</button>
                <button onclick="router('investments')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-xl text-gray-500 hover:bg-gray-50 hover:text-indigo-600 transition"><i class="fas fa-chart-line w-5"></i> Investments</button>
                <button onclick="router('accounts')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-xl text-gray-500 hover:bg-gray-50 hover:text-indigo-600 transition"><i class="fas fa-wallet w-5"></i> Accounts</button>
                <button onclick="router('calendar')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-xl text-gray-500 hover:bg-gray-50 hover:text-indigo-600 transition"><i class="fas fa-calendar-alt w-5"></i> Calendar</button>
                <button onclick="router('future')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-xl text-gray-500 hover:bg-gray-50 hover:text-indigo-600 transition"><i class="fas fa-rocket w-5"></i> Future</button>
                <button onclick="router('activity')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-xl text-gray-500 hover:bg-gray-50 hover:text-indigo-600 transition"><i class="fas fa-list-ul w-5"></i> Activity</button>
                <button onclick="router('reports')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-xl text-gray-500 hover:bg-gray-50 hover:text-indigo-600 transition"><i class="fas fa-file-alt w-5"></i> Reports</button>
                <button onclick="router('profile')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold rounded-xl text-gray-500 hover:bg-gray-50 hover:text-indigo-600 transition"><i class="fas fa-user-circle w-5"></i> Profile</button>
            </nav>
            <div class="p-4 border-t border-gray-100">
                <button onclick="openTxModal()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-indigo-200">
                    <i class="fas fa-plus mr-2"></i> Add Transaction
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <header class="md:hidden sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-gray-100 px-6 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold text-slate-900" id="header-title">Dashboard</h1>
                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold" onclick="router('profile')">U</div>
            </header>

            <div id="view-dashboard" class="view-container active">
                <div class="card bg-slate-900 text-white border-0 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-600 opacity-20 rounded-full blur-3xl transform translate-x-10 -translate-y-10"></div>
                    <div class="relative z-10">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-1">Total Net Worth</div>
                        <div class="text-4xl font-extrabold money" id="dash-networth">...</div>
                        <div class="flex gap-4 mt-6">
                            <div><div class="text-xs text-slate-500 mb-1">Assets</div><div class="text-lg font-bold text-emerald-400 money" id="dash-assets">...</div></div>
                            <div class="w-px bg-white/10"></div>
                            <div><div class="text-xs text-slate-500 mb-1">Liabilities</div><div class="text-lg font-bold text-rose-400 money" id="dash-debts">...</div></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="flex justify-between items-end mb-2">
                        <div><div class="text-label">Monthly Burn</div><div class="text-xs text-gray-400">Income vs Spend</div></div>
                        <div class="font-bold text-indigo-600" id="burn-percent">0%</div>
                    </div>
                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden mb-2">
                        <div id="burn-bar" class="h-full bg-indigo-500 w-0 transition-all duration-1000"></div>
                    </div>
                    <div class="flex justify-between text-xs font-medium text-gray-500">
                        <span id="burn-exp">Exp: 0</span>
                        <span id="burn-inc">Inc: 0</span>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div class="card">
                        <div class="text-label mb-4">Trend (1 Year)</div>
                        <div class="relative h-48 w-full"><canvas id="mainChart"></canvas></div>
                    </div>
                    <div class="card">
                        <div class="text-label mb-4">Allocation</div>
                        <div class="relative h-48 w-full flex justify-center"><canvas id="assetPieChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="view-debts" class="view-container">
                <h2 class="text-2xl font-bold mb-6">Liability Tracker</h2>
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="card"><div class="text-label mb-2">True Cost</div><div class="relative h-48 w-full"><canvas id="debtSplitChart"></canvas></div></div>
                    <div class="card"><div class="text-label mb-2">Composition</div><div class="relative h-48 w-full"><canvas id="debtPieChart"></canvas></div></div>
                </div>
                <div id="debt-list" class="space-y-3"></div>
            </div>

            <div id="view-investments" class="view-container">
                <h2 class="text-2xl font-bold mb-6">Investment Portfolio</h2>
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="card bg-indigo-50 border-indigo-100">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-indigo-600"><i class="fas fa-chart-line"></i></div>
                            <div><div class="text-label text-indigo-400">Total Invested</div><div class="text-2xl font-bold text-indigo-900 money" id="inv-total">0</div></div>
                        </div>
                        <div class="text-xs text-indigo-600 font-medium">Monthly SIP: <span class="money" id="inv-sip">0</span></div>
                    </div>
                    <div class="card">
                        <div class="text-label mb-2">Breakdown</div>
                        <div class="relative h-40 w-full flex justify-center"><canvas id="invPieChart"></canvas></div>
                    </div>
                </div>
                <div id="invest-list" class="space-y-3"></div>
            </div>

            <div id="view-accounts" class="view-container">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Accounts</h2>
                    <button onclick="openModal('accountModal')" class="bg-slate-900 text-white w-8 h-8 rounded-lg flex items-center justify-center"><i class="fas fa-plus"></i></button>
                </div>
                <div id="accounts-list" class="space-y-3"></div>
            </div>

            <div id="view-calendar" class="view-container">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Calendar</h2>
                    <span class="text-sm font-bold text-gray-400" id="cal-month">...</span>
                </div>
                <div class="card p-4">
                    <div class="grid grid-cols-7 gap-2 mb-2 text-center text-[10px] font-bold text-gray-400">
                        <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                    </div>
                    <div id="calendar-grid" class="cal-grid"></div>
                </div>
                <div id="cal-details" class="hidden card mt-4 animate-fade-in">
                    <div class="text-label mb-3" id="cal-selected-date">Date</div>
                    <div id="cal-tx-list" class="space-y-2"></div>
                </div>
            </div>

            <div id="view-future" class="view-container">
                <h2 class="text-2xl font-bold mb-6">Strategy Hub</h2>
                
                <div class="card bg-slate-900 text-white">
                    <div class="flex items-center gap-3 mb-4">
                        <i class="fas fa-fire text-orange-500 text-xl"></i>
                        <h3 class="font-bold">FIRE Calculator</h3>
                    </div>
                    <input type="number" id="fire-expenses" placeholder="Monthly Expenses" class="w-full bg-slate-800 border-none rounded-xl p-3 text-white mb-4 focus:ring-2 focus:ring-orange-500" oninput="calcFire()">
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold">Freedom Number</div>
                        <div class="text-3xl font-bold text-orange-400 money" id="fire-number">0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="text-label mb-4">Wealth Simulator</div>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <input type="number" id="sim-monthly" class="input-field text-xs" value="5000" placeholder="Monthly" oninput="calcSim()">
                        <input type="number" id="sim-rate" class="input-field text-xs" value="12" placeholder="Rate %" oninput="calcSim()">
                        <input type="number" id="sim-years" class="input-field text-xs" value="10" placeholder="Years" oninput="calcSim()">
                    </div>
                    <div class="text-right text-xs font-bold text-indigo-600 mb-2 money" id="sim-result">...</div>
                    <div class="relative h-32 w-full"><canvas id="futureChart"></canvas></div>
                </div>
            </div>

            <div id="view-activity" class="view-container">
                <h2 class="text-2xl font-bold mb-6">Transactions</h2>
                <div class="card p-2 sticky top-0 z-10 mb-4">
                    <input type="text" id="act-search" placeholder="Search..." class="input-field border-0 bg-transparent" onkeyup="renderActivity()">
                </div>
                <div id="activity-list" class="space-y-3 pb-20"></div>
            </div>

            <div id="view-reports" class="view-container">
                <h2 class="text-2xl font-bold mb-6">Reports</h2>
                <div class="card">
                    <div class="flex gap-2 mb-6">
                        <input type="month" id="report-month" class="input-field" onchange="renderReport()">
                        <button onclick="window.print()" class="bg-gray-900 text-white px-4 rounded-xl"><i class="fas fa-print"></i></button>
                    </div>
                    <div id="report-content" class="text-center text-gray-400 text-sm py-8">Select a month to generate report</div>
                </div>
            </div>

            <div id="view-profile" class="view-container">
                <h2 class="text-2xl font-bold mb-6">Profile & Settings</h2>
                
                <div class="card">
                    <div class="text-label mb-3">Identity</div>
                    <div class="flex gap-2">
                        <input type="text" id="profile-name" class="input-field" placeholder="Your Name">
                        <button onclick="saveName()" class="bg-indigo-600 text-white px-4 rounded-xl font-bold">Save</button>
                    </div>
                </div>

                <div class="card space-y-3">
                    <div class="text-label">Data</div>
                    <button onclick="exportCSV()" class="w-full text-left p-3 rounded-xl hover:bg-gray-50 text-sm font-semibold flex items-center gap-3"><i class="fas fa-file-csv text-gray-400"></i> Export CSV</button>
                    <button onclick="backupData()" class="w-full text-left p-3 rounded-xl hover:bg-gray-50 text-sm font-semibold flex items-center gap-3"><i class="fas fa-download text-gray-400"></i> Backup JSON</button>
                    <label class="w-full text-left p-3 rounded-xl hover:bg-gray-50 text-sm font-semibold flex items-center gap-3 cursor-pointer">
                        <i class="fas fa-upload text-gray-400"></i> Restore JSON
                        <input type="file" hidden onchange="restoreData(this)">
                    </label>
                    <button onclick="nukeData()" class="w-full text-left p-3 rounded-xl hover:bg-red-50 text-red-600 text-sm font-bold flex items-center gap-3"><i class="fas fa-trash"></i> Reset All Data</button>
                </div>

                <button onclick="logout()" class="w-full bg-white border border-gray-200 text-red-500 font-bold py-4 rounded-2xl">Sign Out</button>
            </div>

        </main>
    </div>

    <button onclick="openTxModal()" class="fab md:hidden"><i class="fas fa-plus"></i></button>

    <nav class="mobile-dock md:hidden">
        <button onclick="router('dashboard')" id="m-nav-dashboard" class="dock-item"><i class="fas fa-home"></i>Home</button>
        <button onclick="router('debts')" id="m-nav-debts" class="dock-item"><i class="fas fa-file-invoice"></i>Debts</button>
        <button onclick="router('investments')" id="m-nav-investments" class="dock-item"><i class="fas fa-chart-line"></i>Inv</button>
        <button onclick="router('accounts')" id="m-nav-accounts" class="dock-item"><i class="fas fa-wallet"></i>Acc</button>
        <button onclick="router('calendar')" id="m-nav-calendar" class="dock-item"><i class="fas fa-calendar"></i>Cal</button>
        <button onclick="router('future')" id="m-nav-future" class="dock-item"><i class="fas fa-rocket"></i>Fut</button>
        <button onclick="router('activity')" id="m-nav-activity" class="dock-item"><i class="fas fa-list"></i>Act</button>
        <button onclick="router('reports')" id="m-nav-reports" class="dock-item"><i class="fas fa-file-alt"></i>Rpt</button>
        <button onclick="router('profile')" id="m-nav-profile" class="dock-item"><i class="fas fa-user"></i>Pro</button>
    </nav>

    <div id="modal-account" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Add Account</h3>
            <form onsubmit="addAccount(event)" class="space-y-4">
                <input id="accName" class="input-field" placeholder="Name" required>
                <input id="accBalance" type="number" class="input-field" placeholder="Balance" required>
                <select id="accType" class="input-field" onchange="toggleFields()">
                    <option value="cash">Cash/Bank</option>
                    <option value="investment">Investment</option>
                    <option value="property">Property</option>
                    <option value="loan">Loan (Debt)</option>
                    <option value="credit">Credit Card</option>
                </select>
                <div id="extra-fields" class="hidden p-4 bg-gray-50 rounded-xl space-y-3">
                    </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl">Save</button>
                <button type="button" onclick="closeModal('modal-account')" class="w-full text-gray-500 py-2 font-bold">Cancel</button>
            </form>
        </div>
    </div>

    <div id="modal-tx" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" id="tx-title">Transaction</h3>
            <form onsubmit="saveTx(event)" class="space-y-4">
                <input type="hidden" id="txId">
                <input id="txDesc" class="input-field" placeholder="Description" required>
                <div class="flex gap-2">
                    <input id="txAmount" type="number" class="input-field" placeholder="0.00" required>
                    <input id="txDate" type="date" class="input-field" required>
                </div>
                <div class="flex gap-2">
                    <select id="txType" class="input-field" onchange="toggleTxFields()">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                        <option value="transfer">Transfer</option>
                    </select>
                    <select id="txCat" class="input-field">
                        <option value="Food">Food</option><option value="Transport">Transport</option>
                        <option value="Housing">Housing</option><option value="Utilities">Utilities</option>
                        <option value="Shopping">Shopping</option><option value="Salary">Salary</option>
                        <option value="Business">Business</option><option value="Misc">Misc</option>
                    </select>
                </div>
                <select id="txAcc" class="input-field" required></select>
                <select id="txToAcc" class="input-field hidden"></select>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl">Save</button>
                <button type="button" onclick="closeModal('modal-tx')" class="w-full text-gray-500 py-2 font-bold">Cancel</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PASTE KEYS HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVCcds_UxopRp6Vw3vL0YYzr9IjIjR6Lc",
            authDomain: "expense-and-income-faf13.firebaseapp.com",
            projectId: "expense-and-income-faf13",
            storageBucket: "expense-and-income-faf13.firebasestorage.app",
            messagingSenderId: "1278622168",
            appId: "1:1278622168:web:b6e94a4d440d17d7b75aad"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let state = { accounts: [], transactions: [], history: [0] };
        let charts = {}; // Store chart instances

        // --- AUTH ---
        document.getElementById('btn-login').onclick = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e) { alert(e.message); } };
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, u => {
            const ol = document.getElementById('auth-overlay');
            if(u) { ol.classList.add('hidden'); init(u); } else { ol.classList.remove('hidden'); }
        });

        function init(user) {
            onSnapshot(doc(db, "users", user.uid), s => {
                if(s.exists()) { state = s.data(); render(); } else { save(); }
            });
            if(user.displayName) document.getElementById('profile-name').value = user.displayName;
        }

        async function save() { if(auth.currentUser) await setDoc(doc(db, "users", auth.currentUser.uid), state); }

        // --- ROUTER ---
        window.router = (v) => {
            document.querySelectorAll('.view-container').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            
            // Header Title Update
            const titles = { dashboard:'Dashboard', debts:'Debts', investments:'Portfolio', accounts:'Accounts', calendar:'Calendar', future:'Strategy', activity:'Activity', reports:'Reports', profile:'Profile' };
            const ht = document.getElementById('header-title'); if(ht) ht.innerText = titles[v];

            // Nav Active State
            document.querySelectorAll('.dock-item, .desktop-nav-item').forEach(e => {
                e.classList.toggle('active', e.id.includes(v));
            });

            render(); // Re-render for charts
        };

        // --- UI HELPERS ---
        const money = n => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits:0 }).format(n);
        window.openModal = id => { document.getElementById(id).classList.add('open'); if(id==='modal-tx') populateAccSelect(); };
        window.closeModal = id => document.getElementById(id).classList.remove('open');
        window.toggleFields = () => {
            const t = document.getElementById('accType').value;
            const extra = document.getElementById('extra-fields');
            extra.innerHTML = '';
            extra.classList.remove('hidden');
            if(t==='loan'||t==='credit') extra.innerHTML = `<input id="accLimit" type="number" class="input-field" placeholder="Limit / Original Amount"><input id="accRate" type="number" class="input-field" placeholder="Interest %">`;
            else if(t==='investment') extra.innerHTML = `<input id="accSip" type="number" class="input-field" placeholder="Monthly SIP"><input id="accReturn" type="number" class="input-field" placeholder="Exp. Return %">`;
            else extra.classList.add('hidden');
        };
        window.toggleTxFields = () => {
            const t = document.getElementById('txType').value;
            document.getElementById('txToAcc').classList.toggle('hidden', t !== 'transfer');
        };

        // --- CORE LOGIC ---
        window.addAccount = e => {
            e.preventDefault();
            const a = {
                id: Date.now(),
                name: document.getElementById('accName').value,
                balance: parseFloat(document.getElementById('accBalance').value),
                type: document.getElementById('accType').value,
                limit: parseFloat(document.getElementById('accLimit')?.value || 0),
                sip: parseFloat(document.getElementById('accSip')?.value || 0)
            };
            state.accounts.push(a); save(); closeModal('modal-account'); e.target.reset();
        };

        window.saveTx = e => {
            e.preventDefault();
            const id = document.getElementById('txId').value;
            const amt = parseFloat(document.getElementById('txAmount').value);
            const type = document.getElementById('txType').value;
            const accId = parseInt(document.getElementById('txAcc').value);
            
            // Logic to update balance
            const acc = state.accounts.find(x=>x.id===accId);
            if(acc) {
                if(type==='income') acc.balance += amt;
                if(type==='expense') acc.balance -= amt;
                if(type==='transfer') {
                    acc.balance -= amt;
                    const toAcc = state.accounts.find(x=>x.id===parseInt(document.getElementById('txToAcc').value));
                    if(toAcc) toAcc.balance += amt;
                }
            }

            const tx = {
                id: id ? parseInt(id) : Date.now(),
                desc: document.getElementById('txDesc').value,
                amount: amt,
                date: document.getElementById('txDate').value,
                type: type,
                cat: document.getElementById('txCat').value,
                accId: accId
            };

            if(id) { state.transactions = state.transactions.map(t => t.id==id ? tx : t); }
            else { state.transactions.unshift(tx); }
            
            save(); closeModal('modal-tx'); e.target.reset(); showToast("Saved!");
        };

        function populateAccSelect() {
            const s = document.getElementById('txAcc'); const s2 = document.getElementById('txToAcc');
            s.innerHTML = s2.innerHTML = state.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        }

        // --- RENDERERS ---
        function render() {
            const v = document.querySelector('.view-container.active').id;
            
            // DASHBOARD
            if(v === 'view-dashboard') {
                let assets=0, debts=0;
                state.accounts.forEach(a => ['cash','investment','property'].includes(a.type) ? assets+=a.balance : debts+=a.balance);
                document.getElementById('dash-networth').innerText = money(assets-debts);
                document.getElementById('dash-assets').innerText = money(assets);
                document.getElementById('dash-debts').innerText = money(debts);
                
                // Burn Rate
                const now = new Date();
                const mTx = state.transactions.filter(t => new Date(t.date).getMonth() === now.getMonth());
                const inc = mTx.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0);
                const exp = mTx.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0);
                const pct = inc ? Math.min(100, (exp/inc)*100) : 0;
                document.getElementById('burn-percent').innerText = pct.toFixed(0)+'%';
                document.getElementById('burn-bar').style.width = pct+'%';
                document.getElementById('burn-exp').innerText = 'Exp: '+money(exp);
                document.getElementById('burn-inc').innerText = 'Inc: '+money(inc);

                renderChart('mainChart', 'line', [10,20,30,40, assets-debts]); // Simplified
                renderChart('assetPieChart', 'doughnut', [assets, debts]);
            }

            // LISTS
            if(v === 'view-accounts') {
                document.getElementById('accounts-list').innerHTML = state.accounts.map(a => 
                    `<div class="card flex justify-between items-center">
                        <div><div class="font-bold">${a.name}</div><div class="text-xs text-gray-400 uppercase">${a.type}</div></div>
                        <div class="font-bold text-lg">${money(a.balance)}</div>
                    </div>`
                ).join('');
            }

            if(v === 'view-activity') {
                document.getElementById('activity-list').innerHTML = state.transactions.map(t => 
                    `<div class="card flex justify-between items-center p-4">
                        <div class="flex gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-50 text-gray-600"><i class="fas ${t.type==='income'?'fa-arrow-down':'fa-arrow-up'}"></i></div>
                            <div><div class="font-bold text-sm">${t.desc}</div><div class="text-xs text-gray-400">${t.date}</div></div>
                        </div>
                        <div class="font-bold ${t.type==='income'?'text-emerald-600':'text-rose-600'}">${t.type==='income'?'+':'-'}${money(t.amount)}</div>
                    </div>`
                ).join('');
            }
            
            if(v === 'view-calendar') renderCalendar();
        }

        function renderChart(id, type, data) {
            const ctx = document.getElementById(id)?.getContext('2d');
            if(!ctx) return;
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: type,
                data: { labels: data.map((_,i)=>i), datasets: [{ data: data, backgroundColor: ['#4F46E5','#10B981','#F43F5E'], borderColor: '#4F46E5' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x:{display:false}, y:{display:false} } }
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            if(!grid) return;
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate();
            grid.innerHTML = Array.from({length: daysInMonth}, (_, i) => {
                const day = i+1;
                const hasTx = state.transactions.some(t => new Date(t.date).getDate() === day);
                return `<div class="cal-cell ${hasTx?'active':''}">${day}${hasTx?'<div class="cal-dot"></div>':''}</div>`;
            }).join('');
        }

        // --- MISC UTILS ---
        window.openTxModal = () => { document.getElementById('txId').value=''; document.getElementById('txDesc').value=''; document.getElementById('txAmount').value=''; openModal('modal-tx'); };
        window.showToast = msg => { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); };
        window.saveName = async () => { if(auth.currentUser) { await updateProfile(auth.currentUser, {displayName: document.getElementById('profile-name').value}); showToast("Name Saved"); } };
        window.backupData = () => { const a = document.createElement('a'); a.href = 'data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(state)); a.download = 'backup.json'; a.click(); };
        window.restoreData = (el) => { const r = new FileReader(); r.onload = e => { state = JSON.parse(e.target.result); save(); location.reload(); }; r.readAsText(el.files[0]); };
        
        // Init
        document.getElementById('txDate').valueAsDate = new Date();
        router('dashboard');
    </script>
</body>
</html>
